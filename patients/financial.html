<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุญุณุงุจ ุงููุงูู - ุทุจูุจ 24/7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* ุฌููุน ุฃููุงุท CSS ุงูุณุงุจูุฉ ุชุจูู ููุง ูู */
        /* ... CSS ุงููุงูู ูู ุงูุฅุฌุงุจุฉ ุงูุณุงุจูุฉ ... */
    </style>
</head>
<body>
    <!-- ุชุฃุซูุฑุงุช ุงูุฎูููุฉ ุงูุฏููุงููููุฉ -->
    <div class="background-effects">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>

    <!-- ุดุฑูุท ุงูุญุงูุฉ -->
    <div class="status-bar">
        <div class="status-left">
            <span id="currentTime">2:45</span>
        </div>
        <div class="status-right">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-three-quarters"></i>
        </div>
    </div>

    <!-- ุงูุชุทุจูู ุงูุฑุฆูุณู -->
    <div class="premium-app">
        <!-- ุญุงูุฉ ุนุฏู ูุฌูุฏ ุญุณุงุจ -->
        <div id="noAccountState" class="no-account-state">
            <div class="no-account-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="no-account-title">ูุง ููุฌุฏ ุญุณุงุจ ูุงูู</div>
            <div class="no-account-description">
                ูุจุฏู ุฃูู ูู ุชูุดุฆ ุญุณุงุจุงู ุจุนุฏ<br>
                ุฃูุดุฆ ุญุณุงุจู ุงูุดุฎุตู ุฃููุงู ููุชูุชุน ุจุฌููุน ุฎุฏูุงุชูุง ุงููุงููุฉ
            </div>
            <button class="create-account-btn" onclick="redirectToProfile()">
                <i class="fas fa-user-plus"></i>
                ุฅูุดุงุก ุญุณุงุจ ุดุฎุตู
            </button>
        </div>

        <!-- ุงูููุฏุฑ ุงููุงูู (ูุธูุฑ ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ) -->
        <div id="financialHeader" class="financial-header" style="display: none;">
            <div class="header-background"></div>
            
            <!-- ุฃููููุฉ ุฑุจุท ุงููุญุงูุธ -->
            <button class="wallet-link-icon" onclick="openLinkWalletModal()">
                <i class="fas fa-wallet"></i>
            </button>
            
            <div class="client-info">
                <div class="client-avatar" id="clientAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="client-name" id="displayUserName">---</div>
                <div class="account-number" id="displayAccountNumber">---</div>
            </div>
            
            <div class="balance-section">
                <div class="balance-label">ุงูุฑุตูุฏ ุงููุชุงุญ</div>
                <div class="balance-amount pulse" id="displayBalance">0 ุฑ.ู</div>
                <div class="balance-actions">
                    <button class="balance-btn" onclick="openDepositWithPassword()">
                        <i class="fas fa-download"></i>
                        ุฅูุฏุงุน
                    </button>
                    <button class="balance-btn" onclick="openWithdrawWithPassword()">
                        <i class="fas fa-upload"></i>
                        ุณุญุจ
                    </button>
                    <button class="balance-btn" onclick="openTransferWithPassword()">
                        <i class="fas fa-exchange-alt"></i>
                        ุชุญููู
                    </button>
                </div>
            </div>
        </div>

        <!-- ุงููุญุชูู ุงูุฑุฆูุณู (ูุธูุฑ ุจุนุฏ ุฅูุดุงุก ุงูุญุณุงุจ) -->
        <div id="financialContent" class="financial-content" style="display: none;">
            <!-- ุทุฑู ุงูุฏูุน -->
            <div class="section-title">ุทุฑู ุงูุฏูุน</div>
            <div class="payment-methods" id="paymentMethods">
                <!-- ุณูุชู ุชุนุจุฆุชูุง ุจุงูุฌุงูุงุณูุฑุจุช -->
            </div>

            <!-- ุงูููุงุชูุฑ -->
            <div class="section-title">ุงูููุงุชูุฑ</div>
            <div class="transactions-section">
                <div class="section-header">
                    <div class="section-actions">
                        <button class="action-btn" onclick="downloadStatement()">
                            <i class="fas fa-download"></i>
                            ุชุตุฏูุฑ
                        </button>
                        <button class="action-btn" onclick="refreshTransactions()">
                            <i class="fas fa-sync-alt"></i>
                            ุชุญุฏูุซ
                        </button>
                    </div>
                </div>
                <div class="transaction-filters">
                    <button class="filter-btn active" onclick="filterTransactions('all')">
                        ุงููู <span class="filter-count" id="countAll">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTransactions('appointments')">
                        ุงูููุงุนูุฏ <span class="filter-count" id="countAppointments">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTransactions('consultations')">
                        ุงูุงุณุชุดุงุฑุงุช <span class="filter-count" id="countConsultations">0</span>
                    </button>
                    <button class="filter-btn" onclick="filterTransactions('pharmacy')">
                        ุงูุตูุฏููุงุช <span class="filter-count" id="countPharmacy">0</span>
                    </button>
                </div>
                <div class="transaction-list" id="transactionList">
                    <!-- ุณูุชู ุชุนุจุฆุชูุง ุจุงูุฌุงูุงุณูุฑุจุช -->
                </div>
            </div>

            <!-- ุงูุญุฑูุงุช ุงูุฃุฎูุฑุฉ -->
            <div class="section-title">ุงูุญุฑูุงุช ุงูุฃุฎูุฑุฉ</div>
            <div class="recent-activity">
                <div class="activity-list" id="activityList">
                    <!-- ุณูุชู ุชุนุจุฆุชูุง ุจุงูุฌุงูุงุณูุฑุจุช -->
                </div>
            </div>

            <!-- ุงูุชูุฑูุฑ ุงููุงูู -->
            <div class="section-title">ุงูุชูุฑูุฑ ุงููุงูู</div>
            <div class="financial-report">
                <div class="report-stats">
                    <div class="report-stat">
                        <div class="report-value" id="monthlyExpenses">0 ุฑ.ู</div>
                        <div class="report-label">ุงููุตุฑููุงุช ูุฐุง ุงูุดูุฑ</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-value" id="monthlyIncome">0 ุฑ.ู</div>
                        <div class="report-label">ุงูุฅูุฏุงุนุงุช ูุฐุง ุงูุดูุฑ</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-value" id="totalTransactions">0</div>
                        <div class="report-label">ุนุฏุฏ ุงููุนุงููุงุช</div>
                    </div>
                    <div class="report-stat">
                        <div class="report-value" id="digitalWallets">0%</div>
                        <div class="report-label">ูุญุงูุธ ุฑูููุฉ</div>
                    </div>
                </div>
                <div class="report-chart-container">
                    <canvas id="financeChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- ููุงูุฐ ููุจุซูุฉ -->
        
        <!-- ูุงูุฐุฉ ุงูุฅูุฏุงุน -->
        <div id="depositModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุฅูุฏุงุน ุฃููุงู</div>
                    <button class="close-modal" onclick="closeModal('depositModal')">ร</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงููุจูุบ *</label>
                    <input type="number" class="form-input" id="depositAmount" placeholder="ุฃุฏุฎู ุงููุจูุบ ุจุงูุฑูุงู ุงููููู" min="1000" step="100" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุทุฑููุฉ ุงูุฏูุน *</label>
                    <select class="form-select" id="depositMethod" required>
                        <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏูุน</option>
                        <option value="jawali">ุฌูุงูู</option>
                        <option value="jeeb">ุฌูุจ</option>
                        <option value="felousak">ูููุณู</option>
                        <option value="onecash">ูู ูุงุด</option>
                        <option value="yemen_net">ููู ูุช</option>
                        <option value="mobile_money">ููุจุงูู ูููู</option>
                        <option value="kuraimi">ูุญูุธุฉ ุงููุฑููู</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุฑูู ุงููุญูุธุฉ *</label>
                    <input type="text" class="form-input" id="depositWalletNumber" placeholder="ุฃุฏุฎู ุฑูู ุงููุญูุธุฉ" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงูุบุฑุถ ูู ุงูุฅูุฏุงุน</label>
                    <select class="form-select" id="depositPurpose">
                        <option value="general">ุฑุตูุฏ ุนุงู</option>
                        <option value="appointments">ูุฏูุน ุงูููุงุนูุฏ</option>
                        <option value="medications">ูุดุฑุงุก ุงูุฃุฏููุฉ</option>
                        <option value="consultations">ููุงุณุชุดุงุฑุงุช ุงูุทุจูุฉ</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('depositModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="processDeposit()">ุฅูุฏุงุน</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุงูุณุญุจ -->
        <div id="withdrawModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุณุญุจ ุฃููุงู</div>
                    <button class="close-modal" onclick="closeModal('withdrawModal')">ร</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงููุจูุบ *</label>
                    <input type="number" class="form-input" id="withdrawAmount" placeholder="ุฃุฏุฎู ุงููุจูุบ ุจุงูุฑูุงู ุงููููู" min="1000" step="100" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุทุฑููุฉ ุงูุณุญุจ *</label>
                    <select class="form-select" id="withdrawMethod" required onchange="showWithdrawDetails()">
                        <option value="">ุงุฎุชุฑ ุทุฑููุฉ ุงูุณุญุจ</option>
                        <option value="bank_transfer">ุชุญููู ุจููู</option>
                        <option value="wallet">ุฅูู ูุญูุธุฉ ุฑูููุฉ</option>
                        <option value="cash">ุณุญุจ ููุฏู</option>
                    </select>
                </div>
                
                <div id="withdrawBankDetails" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">ุงุณู ุงูุจูู *</label>
                        <input type="text" class="form-input" id="bankName" placeholder="ุงุณู ุงูุจูู">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ุฑูู ุงูุญุณุงุจ ุงูุจููู *</label>
                        <input type="text" class="form-input" id="bankAccount" placeholder="ุฑูู ุงูุญุณุงุจ">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ุงุณู ุตุงุญุจ ุงูุญุณุงุจ *</label>
                        <input type="text" class="form-input" id="accountHolder" placeholder="ุงุณู ุตุงุญุจ ุงูุญุณุงุจ">
                    </div>
                </div>
                
                <div id="withdrawWalletDetails" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">ุฑูู ุงููุญูุธุฉ *</label>
                        <input type="text" class="form-input" id="withdrawWalletNumber" placeholder="ุฑูู ุงููุญูุธุฉ">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงูุบุฑุถ ูู ุงูุณุญุจ</label>
                    <input type="text" class="form-input" id="withdrawPurpose" placeholder="ุงูุบุฑุถ ูู ุงูุณุญุจ">
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('withdrawModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="processWithdrawal()">ุณุญุจ</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุงูุชุญููู -->
        <div id="transferModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุชุญููู ุฃููุงู</div>
                    <button class="close-modal" onclick="closeModal('transferModal')">ร</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงููุจูุบ *</label>
                    <input type="number" class="form-input" id="transferAmount" placeholder="ุฃุฏุฎู ุงููุจูุบ ุจุงูุฑูุงู ุงููููู" min="100" step="10" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ููุน ุงููุณุชูู *</label>
                    <select class="form-select" id="recipientType" required>
                        <option value="">ุงุฎุชุฑ ููุน ุงููุณุชูู</option>
                        <option value="doctor">ุทุจูุจ</option>
                        <option value="hospital">ูุณุชุดูู</option>
                        <option value="pharmacy">ุตูุฏููุฉ</option>
                        <option value="lab">ูุฎุชุจุฑ</option>
                        <option value="individual">ูุฑุฏ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงุณู ุงููุณุชูู *</label>
                    <input type="text" class="form-input" id="recipientName" placeholder="ุงุณู ุงููุณุชูู" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุฑูู ุญุณุงุจ ุงููุณุชูู *</label>
                    <input type="text" class="form-input" id="recipientAccount" placeholder="ุฑูู ุงูุญุณุงุจ ุฃู ุงููุญูุธุฉ" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงูุบุฑุถ ูู ุงูุชุญููู *</label>
                    <input type="text" class="form-input" id="transferPurpose" placeholder="ุงูุบุฑุถ ูู ุงูุชุญููู" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                    <textarea class="form-textarea" id="transferNotes" placeholder="ููุงุญุธุงุช ุฅุถุงููุฉ (ุงุฎุชูุงุฑู)"></textarea>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('transferModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="processTransfer()">ุชุญููู</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุฑุจุท ูุญูุธุฉ -->
        <div id="linkWalletModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุฑุจุท ูุญูุธุฉ ุฑูููุฉ</div>
                    <button class="close-modal" onclick="closeModal('linkWalletModal')">ร</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงุฎุชุฑ ููุน ุงููุญูุธุฉ *</label>
                    <select class="form-select" id="walletType" required onchange="showWalletFields()">
                        <option value="">ุงุฎุชุฑ ุงููุญูุธุฉ</option>
                        <option value="jawali">ุฌูุงูู</option>
                        <option value="jeeb">ุฌูุจ</option>
                        <option value="felousak">ูููุณู</option>
                        <option value="onecash">ูู ูุงุด</option>
                        <option value="yemen_net">ููู ูุช</option>
                        <option value="mobile_money">ููุจุงูู ูููู</option>
                        <option value="kuraimi">ูุญูุธุฉ ุงููุฑููู</option>
                    </select>
                </div>
                
                <div id="walletFields">
                    <!-- ุณูุชู ุชุนุจุฆุชูุง ุฏููุงููููุงู -->
                </div>
                
                <div class="wallet-verification">
                    <h4 style="color: #92400e; margin-bottom: 15px;">ุชูุนูู ุงููุญูุธุฉ</h4>
                    <div class="verification-steps">
                        <div class="verification-step">
                            <div class="step-number active">1</div>
                            <div class="step-label">ุฅุฏุฎุงู ุงูุจูุงูุงุช</div>
                        </div>
                        <div class="verification-step">
                            <div class="step-number">2</div>
                            <div class="step-label">ุงูุชุญูู</div>
                        </div>
                        <div class="verification-step">
                            <div class="step-number">3</div>
                            <div class="step-label">ููุนูุฉ</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('linkWalletModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="linkWallet()">ุฑุจุท ุงููุญูุธุฉ</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ -->
        <div id="passwordConfirmModal" class="modal password-confirm-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุชุฃููุฏ ุงูุนูููุฉ</div>
                    <button class="close-modal" onclick="closeModal('passwordConfirmModal')">ร</button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ูููุฉ ุงููุฑูุฑ ุงููุงููุฉ *</label>
                    <div class="password-input-group">
                        <input type="password" class="form-input" id="confirmPassword" placeholder="ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงููุงููุฉ" required>
                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="transaction-info" id="transactionInfo">
                        <!-- ุณูุชู ุชุนุจุฆุชูุง ุฏููุงููููุงู -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('passwordConfirmModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="confirmTransaction()">ุชุฃููุฏ</button>
                </div>
            </div>
        </div>

        <!-- ูุงูุฐุฉ ุฅุถุงูุฉ ุจุทุงูุฉ -->
        <div id="addCardModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">ุฅุถุงูุฉ ุจุทุงูุฉ ุฏูุน</div>
                    <button class="close-modal" onclick="closeModal('addCardModal')">ร</button>
                </div>
                
                <div class="card-preview">
                    <div class="card-logo">
                        <i class="fab fa-cc-visa"></i>
                    </div>
                    <div class="card-chip"></div>
                    <div class="card-number" id="previewCardNumber">**** **** **** ****</div>
                    <div class="card-details">
                        <div class="card-holder">
                            <div>ุญุงูู ุงูุจุทุงูุฉ</div>
                            <div id="previewCardHolder">ุงูุงุณู ุงููุงูู</div>
                        </div>
                        <div class="card-expiry">
                            <div>ุงูุชูุงุก ุงูุตูุงุญูุฉ</div>
                            <div id="previewCardExpiry">MM/YY</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุฑูู ุงูุจุทุงูุฉ *</label>
                    <input type="text" class="form-input" id="cardNumber" placeholder="1234 5678 9012 3456" 
                           maxlength="19" oninput="formatCardNumber()" onkeyup="updateCardPreview()" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ุงูุชูุงุก ุงูุตูุงุญูุฉ *</label>
                        <input type="text" class="form-input" id="cardExpiry" placeholder="MM/YY" 
                               maxlength="5" oninput="formatExpiry()" onkeyup="updateCardPreview()" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">CVV *</label>
                        <input type="text" class="form-input" id="cardCvv" placeholder="123" 
                               maxlength="3" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ุงุณู ุญุงูู ุงูุจุทุงูุฉ *</label>
                    <input type="text" class="form-input" id="cardHolder" placeholder="ููุง ูู ูุฏูู ุนูู ุงูุจุทุงูุฉ" 
                           onkeyup="updateCardPreview()" required>
                </div>
                
                <div class="payment-security">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-shield-alt" style="color: var(--success);"></i>
                        <span style="font-weight: 700; color: var(--text-primary);">ูุฏููุนุงุช ุขููุฉ</span>
                    </div>
                    <div class="security-features">
                        <div class="security-feature">
                            <i class="fas fa-lock"></i>
                            <span>ูุดูุฑ ุจู SSL</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-user-shield"></i>
                            <span>ุญูุงูุฉ ูู ุงูุงุญุชูุงู</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-check-circle"></i>
                            <span>ูุนุชูุฏ ูู PCI</span>
                        </div>
                        <div class="security-feature">
                            <i class="fas fa-clock"></i>
                            <span>ูุฑุงูุจุฉ 24/7</span>
                        </div>
                    </div>
                </div>
                
                <div class="transaction-limits">
                    <div class="limit-item">
                        <span class="limit-label">ุงูุญุฏ ุงููููู ููุฅูุฏุงุน</span>
                        <span class="limit-value">50,000 ุฑ.ู</span>
                    </div>
                    <div class="limit-item">
                        <span class="limit-label">ุงูุญุฏ ุงููููู ููุณุญุจ</span>
                        <span class="limit-value">20,000 ุฑ.ู</span>
                    </div>
                    <div class="limit-item">
                        <span class="limit-label">ุงูุญุฏ ุงููููู ููุชุญููู</span>
                        <span class="limit-value">30,000 ุฑ.ู</span>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-secondary" onclick="closeModal('addCardModal')">ุฅูุบุงุก</button>
                    <button class="btn btn-primary" onclick="addCard()">ุฅุถุงูุฉ ุงูุจุทุงูุฉ</button>
                </div>
            </div>
        </div>

        <!-- ุดุฑูุท ุงูุชููู ุงูุณููู -->
        <div class="bottom-nav-premium">
            <a href="index.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-home"></i>
                </div>
                <div class="nav-label">ุงูุฑุฆูุณูุฉ</div>
            </a>
            <a href="appointments.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="nav-label">ุงูููุงุนูุฏ</div>
            </a>
            <a href="financial.html" class="nav-item-premium active">
                <div class="nav-icon-premium">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="nav-label">ุงููุงู</div>
            </a>
            <a href="chat.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-comments"></i>
                </div>
                <div class="nav-label">ุงููุญุงุฏุซุฉ</div>
            </a>
            <a href="profile.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-user"></i>
                </div>
                <div class="nav-label">ุงูููู ุงูุดุฎุตู</div>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// ูุธุงู ุงูุชูุงูู ูุน ุงููุญุงูุธ ูุงูุจุทุงูุงุช
class PaymentIntegration {
    constructor() {
        this.walletProviders = {
            'jawali': {
                name: 'ุฌูุงูู',
                logo: 'fa-mobile-alt',
                verificationUrl: 'https://api.jawali.com/verify',
                depositUrl: 'https://api.jawali.com/deposit',
                withdrawUrl: 'https://api.jawali.com/withdraw',
                limits: { daily: 50000, perTransaction: 10000 }
            },
            'jeeb': {
                name: 'ุฌูุจ',
                logo: 'fa-money-bill-wave',
                verificationUrl: 'https://api.jeeb.com/verify',
                depositUrl: 'https://api.jeeb.com/deposit',
                withdrawUrl: 'https://api.jeeb.com/withdraw',
                limits: { daily: 40000, perTransaction: 8000 }
            },
            'felousak': {
                name: 'ูููุณู',
                logo: 'fa-coins',
                verificationUrl: 'https://api.felousak.com/verify',
                depositUrl: 'https://api.felousak.com/deposit',
                withdrawUrl: 'https://api.felousak.com/withdraw',
                limits: { daily: 30000, perTransaction: 5000 }
            },
            'onecash': {
                name: 'ูู ูุงุด',
                logo: 'fa-qrcode',
                verificationUrl: 'https://api.onecash.com/verify',
                depositUrl: 'https://api.onecash.com/deposit',
                withdrawUrl: 'https://api.onecash.com/withdraw',
                limits: { daily: 45000, perTransaction: 9000 }
            },
            'yemen_net': {
                name: 'ููู ูุช',
                logo: 'fa-building',
                verificationUrl: 'https://api.yemennet.com/verify',
                depositUrl: 'https://api.yemennet.com/deposit',
                withdrawUrl: 'https://api.yemennet.com/withdraw',
                limits: { daily: 60000, perTransaction: 15000 }
            },
            'mobile_money': {
                name: 'ููุจุงูู ูููู',
                logo: 'fa-sim-card',
                verificationUrl: 'https://api.mobilemoney.com/verify',
                depositUrl: 'https://api.mobilemoney.com/deposit',
                withdrawUrl: 'https://api.mobilemoney.com/withdraw',
                limits: { daily: 35000, perTransaction: 7000 }
            },
            'kuraimi': {
                name: 'ูุญูุธุฉ ุงููุฑููู',
                logo: 'fa-university',
                verificationUrl: 'https://api.kuraimi.com/verify',
                depositUrl: 'https://api.kuraimi.com/deposit',
                withdrawUrl: 'https://api.kuraimi.com/withdraw',
                limits: { daily: 55000, perTransaction: 12000 }
            }
        };

        this.cardProcessors = {
            'visa': {
                name: 'Visa',
                logo: 'fa-cc-visa',
                processorUrl: 'https://api.visa.com/process',
                verificationUrl: 'https://api.visa.com/verify'
            },
            'mastercard': {
                name: 'MasterCard',
                logo: 'fa-cc-mastercard',
                processorUrl: 'https://api.mastercard.com/process',
                verificationUrl: 'https://api.mastercard.com/verify'
            }
        };
    }

    // ูุญุงูุงุฉ ุงูุงุชุตุงู ุจูุฒูุฏ ุงููุญูุธุฉ
    async verifyWallet(walletType, walletData) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const success = Math.random() > 0.2;
                if (success) {
                    resolve({
                        success: true,
                        message: 'ุชู ุงูุชุญูู ูู ุงููุญูุธุฉ ุจูุฌุงุญ',
                        walletId: 'W' + Date.now(),
                        balance: Math.floor(Math.random() * 10000) + 1000
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'ูุดู ุงูุชุญูู ูู ุงููุญูุธุฉ. ูุฑุฌู ุงูุชุญูู ูู ุงูุจูุงูุงุช'
                    });
                }
            }, 2000);
        });
    }

    // ูุญุงูุงุฉ ุนูููุฉ ุงูุฅูุฏุงุน ุนุจุฑ ุงููุญูุธุฉ
    async processWalletDeposit(walletType, amount, walletNumber) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const success = Math.random() > 0.1;
                if (success) {
                    resolve({
                        success: true,
                        transactionId: 'D' + Date.now(),
                        amount: amount,
                        fee: this.calculateFee(amount, 'deposit'),
                        newBalance: amount - this.calculateFee(amount, 'deposit')
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'ูุดู ุนูููุฉ ุงูุฅูุฏุงุน. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู'
                    });
                }
            }, 3000);
        });
    }

    // ูุญุงูุงุฉ ุนูููุฉ ุงูุณุญุจ ุนุจุฑ ุงููุญูุธุฉ
    async processWalletWithdrawal(walletType, amount, walletNumber) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const success = Math.random() > 0.1;
                if (success) {
                    resolve({
                        success: true,
                        transactionId: 'W' + Date.now(),
                        amount: amount,
                        fee: this.calculateFee(amount, 'withdraw'),
                        netAmount: amount - this.calculateFee(amount, 'withdraw')
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'ูุดู ุนูููุฉ ุงูุณุญุจ. ูุฑุฌู ุงูุชุญูู ูู ุงูุฑุตูุฏ'
                    });
                }
            }, 3000);
        });
    }

    // ูุญุงูุงุฉ ุงูุชุญูู ูู ุงูุจุทุงูุฉ
    async verifyCard(cardData) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const isValid = this.validateCardNumber(cardData.number.replace(/\s/g, ''));
                if (isValid) {
                    resolve({
                        success: true,
                        cardId: 'C' + Date.now(),
                        processor: this.detectCardProcessor(cardData.number),
                        message: 'ุชู ุงูุชุญูู ูู ุงูุจุทุงูุฉ ุจูุฌุงุญ'
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'ุฑูู ุงูุจุทุงูุฉ ุบูุฑ ุตุญูุญ'
                    });
                }
            }, 1500);
        });
    }

    // ูุญุงูุงูุฉ ุนูููุฉ ุงูุฏูุน ุจุงูุจุทุงูุฉ
    async processCardPayment(cardData, amount) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const success = Math.random() > 0.05;
                if (success) {
                    resolve({
                        success: true,
                        transactionId: 'P' + Date.now(),
                        amount: amount,
                        authorizationCode: Math.random().toString(36).substr(2, 8).toUpperCase()
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'ูุดู ุนูููุฉ ุงูุฏูุน. ูุฑุฌู ุงูุชุญูู ูู ุงูุจูุงูุงุช'
                    });
                }
            }, 2500);
        });
    }

    // ุญุณุงุจ ุงูุฑุณูู
    calculateFee(amount, type) {
        const fees = {
            'deposit': amount * 0.01,
            'withdraw': amount * 0.015,
            'transfer': amount * 0.005
        };
        return Math.max(fees[type] || 0, 100);
    }

    // ุงูุชุญูู ูู ุฑูู ุงูุจุทุงูุฉ ุจุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ Luhn
    validateCardNumber(number) {
        let sum = 0;
        let isEven = false;
        
        for (let i = number.length - 1; i >= 0; i--) {
            let digit = parseInt(number[i]);
            
            if (isEven) {
                digit *= 2;
                if (digit > 9) {
                    digit -= 9;
                }
            }
            
            sum += digit;
            isEven = !isEven;
        }
        
        return sum % 10 === 0;
    }

    // ุงูุชุดุงู ููุน ุงูุจุทุงูุฉ
    detectCardProcessor(number) {
        if (/^4/.test(number)) return 'visa';
        if (/^5[1-5]/.test(number)) return 'mastercard';
        return 'unknown';
    }

    // ุฅูุดุงุก ุฑูุฒ ุชุญูู
    generateVerificationCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ูุญุงูุงุฉ ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู
    async sendVerificationCode(phone) {
        return new Promise((resolve) => {
            setTimeout(() => {
                resolve({
                    success: true,
                    code: this.generateVerificationCode(),
                    message: 'ุชู ุฅุฑุณุงู ุฑูุฒ ุงูุชุญูู ุฅูู ูุงุชูู'
                });
            }, 1000);
        });
    }
}

// ูุธุงู ุฅุฏุงุฑุฉ ุงูุญุณุงุจ ุงููุงูู ุงููุชูุฏู
class AdvancedFinancialSystem {
    constructor() {
        this.paymentIntegration = new PaymentIntegration();
        this.linkedWallets = JSON.parse(localStorage.getItem('linkedWallets')) || [];
        this.linkedCards = JSON.parse(localStorage.getItem('linkedCards')) || [];
        this.pendingTransaction = null;
        this.init();
    }

    init() {
        this.checkUserAccount();
        this.updateUI();
        this.startLiveUpdates();
        this.updateTime();
        setInterval(() => this.updateTime(), 60000);
    }

    // ุงูุชุญูู ูู ูุฌูุฏ ุญุณุงุจ ุงููุณุชุฎุฏู - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
    checkUserAccount() {
        console.log('๐ ุฌุงุฑู ุงูุชุญูู ูู ูุฌูุฏ ุญุณุงุจ...');
        
        // ูุญุงููุฉ ูุฑุงุกุฉ ุจูุงูุงุช ุงููุฑูุถ ูู localStorage
        let patientData;
        try {
            patientData = JSON.parse(localStorage.getItem('patient_profile_data'));
            console.log('๐ ุจูุงูุงุช ุงููุฑูุถ:', patientData);
        } catch (error) {
            console.error('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุจูุงูุงุช ุงููุฑูุถ:', error);
            patientData = null;
        }

        if (patientData && patientData.id) {
            console.log('โ ููุฌุฏ ุญุณุงุจ ุดุฎุตู:', patientData.fullName);
            
            // ูุญุงููุฉ ูุฑุงุกุฉ ุงูุญุณุงุจ ุงููุงูู ุงูููุฌูุฏ
            let financialAccount;
            try {
                financialAccount = JSON.parse(localStorage.getItem('financialAccount'));
                console.log('๐ฐ ุงูุญุณุงุจ ุงููุงูู ุงูููุฌูุฏ:', financialAccount);
            } catch (error) {
                console.error('โ ุฎุทุฃ ูู ูุฑุงุกุฉ ุงูุญุณุงุจ ุงููุงูู:', error);
                financialAccount = null;
            }

            if (!financialAccount) {
                console.log('๐ ุฅูุดุงุก ุญุณุงุจ ูุงูู ุฌุฏูุฏ...');
                // ุฅูุดุงุก ุญุณุงุจ ูุงูู ุฌุฏูุฏ
                financialAccount = this.createFinancialAccount(patientData);
            } else {
                console.log('โ ุงุณุชุฎุฏุงู ุงูุญุณุงุจ ุงููุงูู ุงูููุฌูุฏ');
                this.userAccount = financialAccount;
            }
            
            // ุชุญููู ุงูุจูุงูุงุช ุงูุฃุฎุฑู
            this.transactions = JSON.parse(localStorage.getItem('financialTransactions')) || [];
            this.activities = JSON.parse(localStorage.getItem('financialActivities')) || [];
            
            console.log('๐ ุงููุนุงููุงุช:', this.transactions.length);
            console.log('๐ ุงูุฃูุดุทุฉ:', this.activities.length);
            
        } else {
            console.log('โ ูุง ููุฌุฏ ุญุณุงุจ ุดุฎุตู');
            this.userAccount = null;
            this.transactions = [];
            this.activities = [];
        }
    }

    // ุฅูุดุงุก ุญุณุงุจ ูุงูู ุชููุงุฆูุงู ูู ุจูุงูุงุช ุงูููู ุงูุดุฎุตู - ุงูุฅุตุฏุงุฑ ุงููุตุญุญ
    createFinancialAccount(patientData) {
        console.log('๐ ุฅูุดุงุก ุญุณุงุจ ูุงูู ุฌุฏูุฏ...');
        
        const accountNumber = 'FA' + Date.now().toString().slice(-8);
        const newAccount = {
            fullName: patientData.fullName,
            accountNumber: accountNumber,
            balance: 0,
            phone: patientData.phoneNumber,
            email: patientData.email || '',
            createdAt: new Date().toISOString(),
            status: 'active',
            patientId: patientData.id,
            avatar: patientData.avatar || '',
            transactionPassword: patientData.transactionPassword || ''
        };

        console.log('โ ุงูุญุณุงุจ ุงูุฌุฏูุฏ:', newAccount);
        
        this.userAccount = newAccount;
        localStorage.setItem('financialAccount', JSON.stringify(newAccount));
        
        this.addActivity('account_creation', 'ุฅูุดุงุก ุงูุญุณุงุจ ุงููุงูู', 0, 'ุงูุขู');
        this.showNotification('ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุงููุงูู ุจูุฌุงุญ', 'success');
        
        return newAccount;
    }

    updateUI() {
        console.log('๐จ ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู...');
        console.log('๐ค ุจูุงูุงุช ุงููุณุชุฎุฏู:', this.userAccount);
        
        if (this.userAccount) {
            document.getElementById('noAccountState').style.display = 'none';
            document.getElementById('financialHeader').style.display = 'block';
            document.getElementById('financialContent').style.display = 'block';
            
            // ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏู
            document.getElementById('displayUserName').textContent = this.userAccount.fullName || '---';
            document.getElementById('displayAccountNumber').textContent = `ุฑูู ุงูุญุณุงุจ: ${this.userAccount.accountNumber || '---'}`;
            document.getElementById('displayBalance').textContent = `${(this.userAccount.balance || 0).toLocaleString()} ุฑ.ู`;
            
            // ุชุญุฏูุซ ุตูุฑุฉ ุงูุจุฑููุงูู
            const clientAvatar = document.getElementById('clientAvatar');
            if (this.userAccount.avatar) {
                clientAvatar.innerHTML = `<img src="${this.userAccount.avatar}" alt="${this.userAccount.fullName}">`;
                console.log('๐ผ๏ธ ุชู ุชุญููู ุตูุฑุฉ ุงูุจุฑููุงูู');
            } else {
                clientAvatar.innerHTML = '<i class="fas fa-user"></i>';
                console.log('๐ค ุงุณุชุฎุฏุงู ุงูุฃููููุฉ ุงูุงูุชุฑุงุถูุฉ');
            }
            
            this.renderPaymentMethods();
            this.renderTransactions();
            this.renderActivities();
            this.updateFinancialReport();
            this.initializeChart();
            
            console.log('โ ุชู ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจูุฌุงุญ');
        } else {
            console.log('โ ูุง ููุฌุฏ ุญุณุงุจุ ุนุฑุถ ุญุงูุฉ ุนุฏู ูุฌูุฏ ุญุณุงุจ');
            document.getElementById('noAccountState').style.display = 'block';
            document.getElementById('financialHeader').style.display = 'none';
            document.getElementById('financialContent').style.display = 'none';
        }
    }

    // ูุชุญ ูุงูุฐุฉ ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ
    openPasswordConfirm(transactionType, transactionData) {
        this.pendingTransaction = {
            type: transactionType,
            data: transactionData
        };

        let transactionInfo = '';
        switch (transactionType) {
            case 'deposit':
                transactionInfo = `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; border-right: 4px solid var(--success);">
                        <div style="font-weight: 700; margin-bottom: 8px;">ุชูุงุตูู ุงูุฅูุฏุงุน:</div>
                        <div>ุงููุจูุบ: <strong>${transactionData.amount.toLocaleString()} ุฑ.ู</strong></div>
                        <div>ุทุฑููุฉ ุงูุฏูุน: <strong>${this.getPaymentMethodName(transactionData.method)}</strong></div>
                    </div>
                `;
                break;
            case 'withdrawal':
                transactionInfo = `
                    <div style="background: #fef2f2; padding: 15px; border-radius: 12px; border-right: 4px solid var(--error);">
                        <div style="font-weight: 700; margin-bottom: 8px;">ุชูุงุตูู ุงูุณุญุจ:</div>
                        <div>ุงููุจูุบ: <strong>${transactionData.amount.toLocaleString()} ุฑ.ู</strong></div>
                        <div>ุทุฑููุฉ ุงูุณุญุจ: <strong>${this.getPaymentMethodName(transactionData.method)}</strong></div>
                    </div>
                `;
                break;
            case 'transfer':
                transactionInfo = `
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 12px; border-right: 4px solid var(--info);">
                        <div style="font-weight: 700; margin-bottom: 8px;">ุชูุงุตูู ุงูุชุญููู:</div>
                        <div>ุงููุจูุบ: <strong>${transactionData.amount.toLocaleString()} ุฑ.ู</strong></div>
                        <div>ุงููุณุชูู: <strong>${transactionData.recipientName}</strong></div>
                        <div>ุงูุบุฑุถ: <strong>${transactionData.purpose}</strong></div>
                    </div>
                `;
                break;
        }

        document.getElementById('transactionInfo').innerHTML = transactionInfo;
        document.getElementById('confirmPassword').value = '';
        openModal('passwordConfirmModal');
    }

    // ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ
    verifyPassword(password) {
        if (!this.userAccount || !this.userAccount.transactionPassword) {
            return false;
        }
        return this.userAccount.transactionPassword === password;
    }

    async processDeposit(depositData) {
        if (!this.userAccount) {
            this.showNotification('ูุง ููุฌุฏ ุญุณุงุจ ูุงูู', 'error');
            return false;
        }

        const wallet = this.linkedWallets.find(w => w.type === depositData.method);
        if (!wallet) {
            this.showNotification('ุงููุญูุธุฉ ุบูุฑ ูุฑุจูุทุฉ', 'error');
            return false;
        }

        this.showNotification('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุฅูุฏุงุน...', 'info');

        const result = await this.paymentIntegration.processWalletDeposit(
            depositData.method,
            depositData.amount,
            depositData.walletNumber
        );

        if (result.success) {
            // ุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ
            const walletIndex = this.linkedWallets.findIndex(w => w.type === depositData.method);
            if (walletIndex !== -1) {
                this.linkedWallets[walletIndex].balance += result.newBalance;
            }
            
            // ุชุญุฏูุซ ุฑุตูุฏ ุงูุญุณุงุจ ุงูุฑุฆูุณู
            this.userAccount.balance += depositData.amount;
            
            // ุชุณุฌูู ุงููุนุงููุฉ
            const transaction = {
                id: result.transactionId,
                type: 'deposit',
                title: `ุฅูุฏุงุน ุนุจุฑ ${wallet.name}`,
                description: `ุฅูุฏุงุน ูู ุงููุญูุธุฉ - ${depositData.purpose}`,
                amount: depositData.amount,
                ref: result.transactionId,
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG'),
                status: 'completed',
                icon: 'icon-consultation',
                method: depositData.method,
                walletNumber: depositData.walletNumber,
                fee: result.fee
            };

            this.transactions.unshift(transaction);
            this.addActivity('deposit', `ุฅูุฏุงุน ุนุจุฑ ${wallet.name}`, depositData.amount, 'ุงูุขู');
            
            this.saveData();
            this.updateUI();
            this.showNotification(`ุชู ุงูุฅูุฏุงุน ุจูุฌุงุญ: ${depositData.amount.toLocaleString()} ุฑ.ู`, 'success');
            
            return true;
        } else {
            this.showNotification(result.message, 'error');
            return false;
        }
    }

    async processWithdrawal(withdrawalData) {
        if (!this.userAccount) {
            this.showNotification('ูุง ููุฌุฏ ุญุณุงุจ ูุงูู', 'error');
            return false;
        }

        if (this.userAccount.balance < withdrawalData.amount) {
            this.showNotification('ุงูุฑุตูุฏ ุบูุฑ ูุงูู', 'error');
            return false;
        }

        const wallet = this.linkedWallets.find(w => w.type === withdrawalData.method);
        if (!wallet) {
            this.showNotification('ุงููุญูุธุฉ ุบูุฑ ูุฑุจูุทุฉ', 'error');
            return false;
        }

        this.showNotification('ุฌุงุฑู ูุนุงูุฌุฉ ุงูุณุญุจ...', 'info');

        const result = await this.paymentIntegration.processWalletWithdrawal(
            withdrawalData.method,
            withdrawalData.amount,
            withdrawalData.walletNumber
        );

        if (result.success) {
            // ุชุญุฏูุซ ุฑุตูุฏ ุงููุญูุธุฉ
            const walletIndex = this.linkedWallets.findIndex(w => w.type === withdrawalData.method);
            if (walletIndex !== -1) {
                this.linkedWallets[walletIndex].balance += result.netAmount;
            }
            
            // ุชุญุฏูุซ ุฑุตูุฏ ุงูุญุณุงุจ ุงูุฑุฆูุณู
            this.userAccount.balance -= withdrawalData.amount;
            
            // ุชุณุฌูู ุงููุนุงููุฉ
            const transaction = {
                id: result.transactionId,
                type: 'withdrawal',
                title: `ุณุญุจ ุนุจุฑ ${wallet.name}`,
                description: `ุณุญุจ ุฅูู ุงููุญูุธุฉ - ${withdrawalData.purpose}`,
                amount: -withdrawalData.amount,
                ref: result.transactionId,
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG'),
                status: 'completed',
                icon: 'icon-hospital',
                method: withdrawalData.method,
                walletNumber: withdrawalData.walletNumber,
                fee: result.fee,
                netAmount: result.netAmount
            };

            this.transactions.unshift(transaction);
            this.addActivity('withdrawal', `ุณุญุจ ุนุจุฑ ${wallet.name}`, -withdrawalData.amount, 'ุงูุขู');
            
            this.saveData();
            this.updateUI();
            this.showNotification(`ุชู ุงูุณุญุจ ุจูุฌุงุญ: ${withdrawalData.amount.toLocaleString()} ุฑ.ู`, 'success');
            
            return true;
        } else {
            this.showNotification(result.message, 'error');
            return false;
        }
    }

    processTransfer(transferData) {
        if (!this.userAccount) {
            this.showNotification('ูุง ููุฌุฏ ุญุณุงุจ ูุงูู', 'error');
            return false;
        }

        if (this.userAccount.balance < transferData.amount) {
            this.showNotification('ุงูุฑุตูุฏ ุบูุฑ ูุงูู', 'error');
            return false;
        }

        const transactionId = 'TR' + Date.now().toString().slice(-8);
        const newTransaction = {
            id: transactionId,
            type: 'transfer',
            title: `ุชุญููู ุฅูู ${transferData.recipientName}`,
            description: `ุชุญููู ${transferData.purpose} - ${transferData.notes || 'ูุง ุชูุฌุฏ ููุงุญุธุงุช'}`,
            amount: -transferData.amount,
            ref: transactionId,
            date: new Date().toLocaleDateString('ar-EG'),
            time: new Date().toLocaleTimeString('ar-EG'),
            status: 'completed',
            icon: 'icon-appointment',
            recipient: transferData.recipientName,
            account: transferData.recipientAccount,
            purpose: transferData.purpose
        };

        this.userAccount.balance -= transferData.amount;
        this.transactions.unshift(newTransaction);
        this.addActivity('transfer', `ุชุญููู ุฅูู ${transferData.recipientName}`, -transferData.amount, 'ุงูุขู');

        this.saveData();
        this.updateUI();
        this.showNotification(`ุชู ุงูุชุญููู ุจูุฌุงุญ: ${transferData.amount.toLocaleString()} ุฑ.ู`, 'success');
        
        return true;
    }

    // ุฑุจุท ูุญูุธุฉ ุฌุฏูุฏุฉ
    async linkWallet(walletData) {
        const verification = await this.paymentIntegration.verifyWallet(walletData.type, walletData);
        
        if (verification.success) {
            const linkedWallet = {
                id: verification.walletId,
                type: walletData.type,
                name: this.paymentIntegration.walletProviders[walletData.type].name,
                number: walletData.number,
                balance: verification.balance,
                isVerified: true,
                linkedAt: new Date().toISOString()
            };
            
            this.linkedWallets.push(linkedWallet);
            localStorage.setItem('linkedWallets', JSON.stringify(this.linkedWallets));
            
            this.showNotification(`ุชู ุฑุจุท ูุญูุธุฉ ${linkedWallet.name} ุจูุฌุงุญ`, 'success');
            return true;
        } else {
            this.showNotification(verification.message, 'error');
            return false;
        }
    }

    // ุฅุถุงูุฉ ุจุทุงูุฉ ุฌุฏูุฏุฉ
    async addCard(cardData) {
        const verification = await this.paymentIntegration.verifyCard(cardData);
        
        if (verification.success) {
            const linkedCard = {
                id: verification.cardId,
                number: this.maskCardNumber(cardData.number),
                lastFour: cardData.number.slice(-4),
                holder: cardData.holder,
                expiry: cardData.expiry,
                processor: verification.processor,
                isVerified: true,
                addedAt: new Date().toISOString()
            };
            
            this.linkedCards.push(linkedCard);
            localStorage.setItem('linkedCards', JSON.stringify(this.linkedCards));
            
            this.showNotification('ุชู ุฅุถุงูุฉ ุงูุจุทุงูุฉ ุจูุฌุงุญ', 'success');
            return true;
        } else {
            this.showNotification(verification.message, 'error');
            return false;
        }
    }

    renderPaymentMethods() {
        const container = document.getElementById('paymentMethods');
        if (!container) return;
        
        container.innerHTML = '';

        // ุนุฑุถ ุงููุญุงูุธ ุงููุฑุจูุทุฉ
        this.linkedWallets.forEach(wallet => {
            const methodElement = document.createElement('div');
            methodElement.className = 'payment-method active';
            methodElement.onclick = () => this.selectPaymentMethod(wallet.id);
            
            methodElement.innerHTML = `
                <div class="payment-icon">
                    <i class="fas ${this.paymentIntegration.walletProviders[wallet.type].logo}"></i>
                </div>
                <div class="payment-name">${wallet.name}</div>
                <div class="payment-balance">${wallet.balance.toLocaleString()} ุฑ.ู</div>
            `;
            
            container.appendChild(methodElement);
        });

        // ุนุฑุถ ุงูุจุทุงูุงุช ุงููุฑุจูุทุฉ
        this.linkedCards.forEach(card => {
            const methodElement = document.createElement('div');
            methodElement.className = 'payment-method active';
            methodElement.onclick = () => this.selectPaymentMethod(card.id);
            
            methodElement.innerHTML = `
                <div class="payment-icon">
                    <i class="fab fa-cc-${card.processor}"></i>
                </div>
                <div class="payment-name">${card.processor}</div>
                <div class="payment-balance">${card.lastFour}</div>
            `;
            
            container.appendChild(methodElement);
        });

        // ุฃุฒุฑุงุฑ ุงูุฅุถุงูุฉ
        const addWalletBtn = document.createElement('div');
        addWalletBtn.className = 'payment-method';
        addWalletBtn.onclick = openLinkWalletModal;
        addWalletBtn.innerHTML = `
            <div class="payment-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="payment-name">ุฑุจุท ูุญูุธุฉ</div>
            <div class="payment-balance">ุฌุฏูุฏ</div>
        `;
        container.appendChild(addWalletBtn);

        const addCardBtn = document.createElement('div');
        addCardBtn.className = 'payment-method';
        addCardBtn.onclick = openAddCardModal;
        addCardBtn.innerHTML = `
            <div class="payment-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <div class="payment-name">ุฅุถุงูุฉ ุจุทุงูุฉ</div>
            <div class="payment-balance">ุฌุฏูุฏ</div>
        `;
        container.appendChild(addCardBtn);
    }

    renderTransactions(filter = 'all') {
        const container = document.getElementById('transactionList');
        if (!container) return;
        
        container.innerHTML = '';

        const filteredTransactions = filter === 'all' 
            ? this.transactions 
            : this.transactions.filter(t => t.type === filter);

        this.updateFilterCounts();

        if (filteredTransactions.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-receipt" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div>ูุง ุชูุฌุฏ ูุนุงููุงุช</div>
                </div>
            `;
            return;
        }

        filteredTransactions.forEach(transaction => {
            const transactionElement = document.createElement('div');
            transactionElement.className = 'transaction-item';
            transactionElement.onclick = () => this.showTransactionDetails(transaction);
            
            transactionElement.innerHTML = `
                <div class="transaction-icon ${transaction.icon}">
                    <i class="fas ${this.getTransactionIcon(transaction.type)}"></i>
                </div>
                <div class="transaction-details">
                    <div class="transaction-title">${transaction.title}</div>
                    <div class="transaction-description">${transaction.description}</div>
                    <div class="transaction-meta">
                        <span class="transaction-ref">${transaction.ref}</span>
                        <span>${transaction.date} - ${transaction.time}</span>
                    </div>
                </div>
                <div class="transaction-amount" style="color: ${transaction.amount >= 0 ? 'var(--success)' : 'var(--error)'}">
                    ${transaction.amount >= 0 ? '+' : ''}${transaction.amount} ุฑ.ู
                </div>
                <div class="transaction-status">ููุชูู</div>
            `;
            
            container.appendChild(transactionElement);
        });
    }

    renderActivities() {
        const container = document.getElementById('activityList');
        if (!container) return;
        
        container.innerHTML = '';

        if (this.activities.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <i class="fas fa-history" style="font-size: 32px; margin-bottom: 8px;"></i>
                    <div>ูุง ุชูุฌุฏ ุญุฑูุงุช ุญุฏูุซุฉ</div>
                </div>
            `;
            return;
        }

        this.activities.forEach(activity => {
            const activityElement = document.createElement('div');
            activityElement.className = 'activity-item';
            
            activityElement.innerHTML = `
                <div class="activity-icon">
                    <i class="fas ${activity.icon}"></i>
                </div>
                <div class="activity-details">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-time">${activity.time}</div>
                </div>
                <div class="activity-amount ${activity.amount > 0 ? 'amount-positive' : 'amount-negative'}">
                    ${activity.amount > 0 ? '+' : ''}${activity.amount} ุฑ.ู
                </div>
            `;
            
            container.appendChild(activityElement);
        });
    }

    updateFilterCounts() {
        const counts = {
            all: this.transactions.length,
            appointments: this.transactions.filter(t => t.type === 'appointment').length,
            consultations: this.transactions.filter(t => t.type === 'consultation').length,
            pharmacy: this.transactions.filter(t => t.type === 'pharmacy').length
        };

        const countAll = document.getElementById('countAll');
        const countAppointments = document.getElementById('countAppointments');
        const countConsultations = document.getElementById('countConsultations');
        const countPharmacy = document.getElementById('countPharmacy');

        if (countAll) countAll.textContent = counts.all;
        if (countAppointments) countAppointments.textContent = counts.appointments;
        if (countConsultations) countConsultations.textContent = counts.consultations;
        if (countPharmacy) countPharmacy.textContent = counts.pharmacy;
    }

    updateFinancialReport() {
        const currentMonth = new Date().getMonth();
        const monthlyTransactions = this.transactions.filter(t => {
            const transactionDate = new Date(t.date);
            return transactionDate.getMonth() === currentMonth;
        });

        const monthlyExpenses = monthlyTransactions
            .filter(t => t.amount < 0)
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);

        const monthlyIncome = monthlyTransactions
            .filter(t => t.amount > 0)
            .reduce((sum, t) => sum + t.amount, 0);

        const monthlyExpensesElem = document.getElementById('monthlyExpenses');
        const monthlyIncomeElem = document.getElementById('monthlyIncome');
        const totalTransactionsElem = document.getElementById('totalTransactions');
        const digitalWalletsElem = document.getElementById('digitalWallets');

        if (monthlyExpensesElem) monthlyExpensesElem.textContent = monthlyExpenses.toLocaleString() + ' ุฑ.ู';
        if (monthlyIncomeElem) monthlyIncomeElem.textContent = monthlyIncome.toLocaleString() + ' ุฑ.ู';
        if (totalTransactionsElem) totalTransactionsElem.textContent = this.transactions.length;
        if (digitalWalletsElem) digitalWalletsElem.textContent = this.linkedWallets.length > 0 ? '100%' : '0%';
    }

    initializeChart() {
        const ctx = document.getElementById('financeChart');
        if (!ctx) return;
        
        const expenseData = {
            appointments: this.transactions.filter(t => t.type === 'appointment' && t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
            consultations: this.transactions.filter(t => t.type === 'consultation' && t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
            pharmacy: this.transactions.filter(t => t.type === 'pharmacy' && t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
            hospital: this.transactions.filter(t => t.type === 'hospital' && t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0)
        };

        if (window.financeChart) {
            window.financeChart.destroy();
        }

        window.financeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['ุงูููุงุนูุฏ', 'ุงูุงุณุชุดุงุฑุงุช', 'ุงูุตูุฏููุงุช', 'ุงููุณุชุดููุงุช'],
                datasets: [{
                    data: [
                        expenseData.appointments,
                        expenseData.consultations,
                        expenseData.pharmacy,
                        expenseData.hospital
                    ],
                    backgroundColor: [
                        '#8b5cf6',
                        '#3b82f6',
                        '#f59e0b',
                        '#ef4444'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        rtl: true,
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: {
                                family: 'Tajawal',
                                size: 12
                            }
                        }
                    }
                },
                cutout: '65%'
            }
        });
    }

    addActivity(type, title, amount, time) {
        const activity = {
            id: Date.now(),
            type: type,
            title: title,
            amount: amount,
            time: time,
            icon: this.getActivityIcon(type)
        };
        
        this.activities.unshift(activity);
        if (this.activities.length > 10) {
            this.activities.pop();
        }
        
        localStorage.setItem('financialActivities', JSON.stringify(this.activities));
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 4000);
    }

    saveData() {
        if (this.userAccount) {
            localStorage.setItem('financialAccount', JSON.stringify(this.userAccount));
        }
        localStorage.setItem('financialTransactions', JSON.stringify(this.transactions));
        localStorage.setItem('financialActivities', JSON.stringify(this.activities));
        localStorage.setItem('linkedWallets', JSON.stringify(this.linkedWallets));
        localStorage.setItem('linkedCards', JSON.stringify(this.linkedCards));
    }

    updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ar-EG', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        const currentTimeElem = document.getElementById('currentTime');
        if (currentTimeElem) {
            currentTimeElem.textContent = timeString;
        }
    }

    startLiveUpdates() {
        setInterval(() => {
            if (this.userAccount && Math.random() > 0.7) {
                this.updateUI();
            }
        }, 60000);
    }

    // ูุธุงุฆู ูุณุงุนุฏุฉ
    getPaymentMethodName(methodId) {
        const methods = {
            'jawali': 'ุฌูุงูู',
            'jeeb': 'ุฌูุจ',
            'felousak': 'ูููุณู',
            'onecash': 'ูู ูุงุด',
            'yemen_net': 'ููู ูุช',
            'mobile_money': 'ููุจุงูู ูููู',
            'kuraimi': 'ูุญูุธุฉ ุงููุฑููู'
        };
        return methods[methodId] || methodId;
    }

    getActivityIcon(type) {
        const icons = {
            'deposit': 'fa-download',
            'withdrawal': 'fa-upload',
            'transfer': 'fa-exchange-alt',
            'account_creation': 'fa-user-plus',
            'payment': 'fa-credit-card'
        };
        return icons[type] || 'fa-exchange-alt';
    }

    getTransactionIcon(type) {
        const icons = {
            'deposit': 'fa-download',
            'withdrawal': 'fa-upload',
            'transfer': 'fa-exchange-alt',
            'consultation': 'fa-user-md',
            'appointment': 'fa-calendar-check',
            'hospital': 'fa-hospital',
            'pharmacy': 'fa-pills'
        };
        return icons[type] || 'fa-receipt';
    }

    maskCardNumber(number) {
        return '**** **** **** ' + number.slice(-4);
    }

    selectPaymentMethod(methodId) {
        this.showNotification('ุชู ุงุฎุชูุงุฑ ุทุฑููุฉ ุงูุฏูุน', 'info');
    }

    showTransactionDetails(transaction) {
        let details = `ุชูุงุตูู ุงููุนุงููุฉ:\n\n`;
        details += `ุงูุฎุฏูุฉ: ${transaction.title}\n`;
        details += `ุงููุตู: ${transaction.description}\n`;
        details += `ุงููุจูุบ: ${transaction.amount} ุฑ.ู\n`;
        details += `ุฑูู ุงููุฑุฌุน: ${transaction.ref}\n`;
        details += `ุงูุชุงุฑูุฎ: ${transaction.date} ${transaction.time}\n`;
        details += `ุงูุญุงูุฉ: ${transaction.status}\n`;
        
        if (transaction.method) {
            details += `ุทุฑููุฉ ุงูุฏูุน: ${this.getPaymentMethodName(transaction.method)}\n`;
        }
        
        if (transaction.recipient) {
            details += `ุงููุณุชูู: ${transaction.recipient}\n`;
        }

        alert(details);
    }
}

// ุชููุฆุฉ ุงููุธุงู ุงููุชูุฏู
const advancedFinancialSystem = new AdvancedFinancialSystem();

// ูุธุงุฆู ุงููุงุฌูุฉ ุงูุนุงูุฉ
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
    }
}

function redirectToProfile() {
    window.location.href = 'patient-profile.html';
}

// ูุธุงุฆู ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ
function openDepositWithPassword() {
    openModal('depositModal');
}

function openWithdrawWithPassword() {
    openModal('withdrawModal');
}

function openTransferWithPassword() {
    openModal('transferModal');
}

async function confirmTransaction() {
    const password = document.getElementById('confirmPassword');
    if (!password) return;
    
    const passwordValue = password.value;
    
    if (!passwordValue) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ', 'error');
        return;
    }

    if (!advancedFinancialSystem.verifyPassword(passwordValue)) {
        advancedFinancialSystem.showNotification('ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ', 'error');
        return;
    }

    closeModal('passwordConfirmModal');
    
    const pendingTransaction = advancedFinancialSystem.pendingTransaction;
    if (!pendingTransaction) return;

    let success = false;
    
    switch (pendingTransaction.type) {
        case 'deposit':
            success = await advancedFinancialSystem.processDeposit(pendingTransaction.data);
            break;
        case 'withdrawal':
            success = await advancedFinancialSystem.processWithdrawal(pendingTransaction.data);
            break;
        case 'transfer':
            success = advancedFinancialSystem.processTransfer(pendingTransaction.data);
            break;
    }

    if (success) {
        // ุฅุบูุงู ุงูููุงูุฐ ุงูููุชูุญุฉ
        closeModal('depositModal');
        closeModal('withdrawModal');
        closeModal('transferModal');
    }
}

async function processDeposit() {
    const depositAmount = document.getElementById('depositAmount');
    const depositMethod = document.getElementById('depositMethod');
    const depositWalletNumber = document.getElementById('depositWalletNumber');
    const depositPurpose = document.getElementById('depositPurpose');

    if (!depositAmount || !depositMethod || !depositWalletNumber) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    const depositData = {
        amount: parseFloat(depositAmount.value),
        method: depositMethod.value,
        walletNumber: depositWalletNumber.value,
        purpose: depositPurpose ? depositPurpose.value : 'general'
    };

    if (!depositData.amount || !depositData.method || !depositData.walletNumber) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    if (depositData.amount < 1000) {
        advancedFinancialSystem.showNotification('ุงูุญุฏ ุงูุฃุฏูู ููุฅูุฏุงุน ูู 1000 ุฑ.ู', 'error');
        return;
    }

    advancedFinancialSystem.openPasswordConfirm('deposit', depositData);
}

async function processWithdrawal() {
    const withdrawAmount = document.getElementById('withdrawAmount');
    const withdrawMethod = document.getElementById('withdrawMethod');
    const withdrawPurpose = document.getElementById('withdrawPurpose');
    const withdrawWalletNumber = document.getElementById('withdrawWalletNumber');

    if (!withdrawAmount || !withdrawMethod) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    const withdrawalData = {
        amount: parseFloat(withdrawAmount.value),
        method: withdrawMethod.value,
        purpose: withdrawPurpose ? withdrawPurpose.value : '',
        walletNumber: withdrawWalletNumber ? withdrawWalletNumber.value : ''
    };

    if (!withdrawalData.amount || !withdrawalData.method) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    if (withdrawalData.amount < 1000) {
        advancedFinancialSystem.showNotification('ุงูุญุฏ ุงูุฃุฏูู ููุณุญุจ ูู 1000 ุฑ.ู', 'error');
        return;
    }

    advancedFinancialSystem.openPasswordConfirm('withdrawal', withdrawalData);
}

function processTransfer() {
    const transferAmount = document.getElementById('transferAmount');
    const recipientType = document.getElementById('recipientType');
    const recipientName = document.getElementById('recipientName');
    const recipientAccount = document.getElementById('recipientAccount');
    const transferPurpose = document.getElementById('transferPurpose');
    const transferNotes = document.getElementById('transferNotes');

    if (!transferAmount || !recipientType || !recipientName || !recipientAccount || !transferPurpose) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    const transferData = {
        amount: parseFloat(transferAmount.value),
        recipientType: recipientType.value,
        recipientName: recipientName.value,
        recipientAccount: recipientAccount.value,
        purpose: transferPurpose.value,
        notes: transferNotes ? transferNotes.value : ''
    };

    if (!transferData.amount || !transferData.recipientType || !transferData.recipientName || !transferData.recipientAccount || !transferData.purpose) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุฅูุฒุงููุฉ', 'error');
        return;
    }

    if (transferData.amount < 100) {
        advancedFinancialSystem.showNotification('ุงูุญุฏ ุงูุฃุฏูู ููุชุญููู ูู 100 ุฑ.ู', 'error');
        return;
    }

    advancedFinancialSystem.openPasswordConfirm('transfer', transferData);
}

function filterTransactions(type) {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    advancedFinancialSystem.renderTransactions(type);
}

function refreshTransactions() {
    advancedFinancialSystem.showNotification('ุฌุงุฑู ุชุญุฏูุซ ุงูุจูุงูุงุช...', 'info');
    setTimeout(() => {
        advancedFinancialSystem.renderTransactions();
        advancedFinancialSystem.showNotification('ุชู ุชุญุฏูุซ ุงูุจูุงูุงุช', 'success');
    }, 1000);
}

function downloadStatement() {
    advancedFinancialSystem.showNotification('ุฌุงุฑู ุชุญููู ูุดู ุงูุญุณุงุจ...', 'info');
    setTimeout(() => {
        advancedFinancialSystem.showNotification('ุชู ุชุญููู ูุดู ุงูุญุณุงุจ ุจูุฌุงุญ', 'success');
    }, 1500);
}

// ูุธุงุฆู ุงููุญุงูุธ ูุงูุจุทุงูุงุช
function showWalletFields() {
    const walletType = document.getElementById('walletType');
    const walletFields = document.getElementById('walletFields');
    
    if (!walletType || !walletFields) return;
    
    if (!walletType.value) {
        walletFields.innerHTML = '';
        return;
    }

    const provider = advancedFinancialSystem.paymentIntegration.walletProviders[walletType.value];
    if (!provider) return;
    
    walletFields.innerHTML = `
        <div class="form-group">
            <label class="form-label">ุฑูู ุงููุญูุธุฉ *</label>
            <input type="text" class="form-input" id="walletNumber" placeholder="ุฃุฏุฎู ุฑูู ${provider.name}" required>
        </div>
        <div class="form-group">
            <label class="form-label">ุงุณู ุตุงุญุจ ุงููุญูุธุฉ *</label>
            <input type="text" class="form-input" id="walletOwner" placeholder="ุงุณู ุตุงุญุจ ุงููุญูุธุฉ" required>
        </div>
        <div class="form-group">
            <label class="form-label">ุฑูู ุงููุงุชู ุงููุณุฌู *</label>
            <input type="tel" class="form-input" id="walletPhone" placeholder="05XXXXXXXX" required>
        </div>
    `;
}

async function linkWallet() {
    const walletType = document.getElementById('walletType');
    const walletNumber = document.getElementById('walletNumber');
    const walletOwner = document.getElementById('walletOwner');
    const walletPhone = document.getElementById('walletPhone');

    if (!walletType || !walletNumber || !walletOwner || !walletPhone) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู', 'error');
        return;
    }

    const walletData = {
        type: walletType.value,
        number: walletNumber.value,
        owner: walletOwner.value,
        phone: walletPhone.value
    };

    const success = await advancedFinancialSystem.linkWallet(walletData);
    if (success) {
        closeModal('linkWalletModal');
        advancedFinancialSystem.renderPaymentMethods();
    }
}

function formatCardNumber() {
    const input = document.getElementById('cardNumber');
    if (!input) return;
    
    let value = input.value.replace(/\s/g, '').replace(/\D/g, '');
    
    if (value.length > 16) {
        value = value.substr(0, 16);
    }
    
    let formatted = '';
    for (let i = 0; i < value.length; i++) {
        if (i > 0 && i % 4 === 0) {
            formatted += ' ';
        }
        formatted += value[i];
    }
    
    input.value = formatted;
}

function formatExpiry() {
    const input = document.getElementById('cardExpiry');
    if (!input) return;
    
    let value = input.value.replace(/\D/g, '');
    
    if (value.length > 4) {
        value = value.substr(0, 4);
    }
    
    if (value.length >= 2) {
        value = value.substr(0, 2) + '/' + value.substr(2);
    }
    
    input.value = value;
}

function updateCardPreview() {
    const cardNumber = document.getElementById('cardNumber');
    const cardExpiry = document.getElementById('cardExpiry');
    const cardHolder = document.getElementById('cardHolder');
    const previewCardNumber = document.getElementById('previewCardNumber');
    const previewCardExpiry = document.getElementById('previewCardExpiry');
    const previewCardHolder = document.getElementById('previewCardHolder');

    if (!cardNumber || !cardExpiry || !cardHolder || !previewCardNumber || !previewCardExpiry || !previewCardHolder) return;

    const number = cardNumber.value || '**** **** **** ****';
    const expiry = cardExpiry.value || 'MM/YY';
    const holder = cardHolder.value || 'ุงูุงุณู ุงููุงูู';
    
    previewCardNumber.textContent = number;
    previewCardExpiry.textContent = expiry;
    previewCardHolder.textContent = holder.toUpperCase();
}

async function addCard() {
    const cardNumber = document.getElementById('cardNumber');
    const cardExpiry = document.getElementById('cardExpiry');
    const cardCvv = document.getElementById('cardCvv');
    const cardHolder = document.getElementById('cardHolder');

    if (!cardNumber || !cardExpiry || !cardCvv || !cardHolder) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู', 'error');
        return;
    }

    const number = cardNumber.value.replace(/\s/g, '');
    const expiry = cardExpiry.value;
    const cvv = cardCvv.value;
    const holder = cardHolder.value;

    if (!number || !expiry || !cvv || !holder) {
        advancedFinancialSystem.showNotification('ูุฑุฌู ููุก ุฌููุน ุงูุญููู', 'error');
        return;
    }

    if (number.replace(/\s/g, '').length !== 16) {
        advancedFinancialSystem.showNotification('ุฑูู ุงูุจุทุงูุฉ ูุฌุจ ุฃู ูููู 16 ุฑููุงู', 'error');
        return;
    }

    const cardData = {
        number: number,
        expiry: expiry,
        cvv: cvv,
        holder: holder
    };

    const success = await advancedFinancialSystem.addCard(cardData);
    if (success) {
        closeModal('addCardModal');
        advancedFinancialSystem.renderPaymentMethods();
    }
}

function openLinkWalletModal() {
    openModal('linkWalletModal');
}

function openAddCardModal() {
    openModal('addCardModal');
}

function showWithdrawDetails() {
    const method = document.getElementById('withdrawMethod');
    const bankDetails = document.getElementById('withdrawBankDetails');
    const walletDetails = document.getElementById('withdrawWalletDetails');

    if (!method || !bankDetails || !walletDetails) return;

    bankDetails.style.display = method.value === 'bank_transfer' ? 'block' : 'none';
    walletDetails.style.display = method.value === 'wallet' ? 'block' : 'none';
}

function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const icon = input.nextElementSibling.querySelector('i');
    if (!icon) return;
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// ุฅุบูุงู ุงูููุงูุฐ ุจุงูุถุบุท ุฎุงุฑุฌูุง
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// ููุน ุฅุฑุณุงู ุงูููุงุฐุฌ
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
    });
});

// ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ุนูุฏ ุงูุนูุฏุฉ ุฅูููุง
window.addEventListener('pageshow', function(event) {
    if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
        location.reload();
    }
});
</script>
</body>
</html>
