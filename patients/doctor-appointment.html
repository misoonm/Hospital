<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حجز موعد مع دكتور - طبيب 24/7</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=El+Messiri:wght@400;500;600;700&family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
:root {
    --primary: #1e40af;
    --primary-dark: #1e3a8a;
    --primary-light: #dbeafe;
    --secondary: #dc2626;
    --accent: #f59e0b;
    --success: #059669;
    --warning: #d97706;
    --error: #dc2626;
    --dark: #1e1b4b;
    --light: #f0f9ff;
    --surface: #ffffff;
    --glass: rgba(255, 255, 255, 0.25);
    --glass-dark: rgba(255, 255, 255, 0.1);
    --text-primary: #1e293b;
    --text-secondary: #475569;
    --text-light: #64748b;
    --gradient-primary: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
    --gradient-hospital: linear-gradient(135deg, #1e40af 0%, #dc2626 100%);
    --gradient-premium: linear-gradient(135deg, #1e40af 0%, #3730a3 50%, #7c3aed 100%);
    --gradient-success: linear-gradient(135deg, #059669 0%, #10b981 100%);
    --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.1);
    --shadow-glass: 0 8px 32px rgba(30, 64, 175, 0.2);
    --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.08);
    --shadow-large: 0 16px 48px rgba(0, 0, 0, 0.15);
    --radius-xl: 24px;
    --radius-lg: 20px;
    --radius-md: 16px;
    --radius-sm: 12px;
    --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-bounce: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Tajawal', 'El Messiri', sans-serif;
    -webkit-tap-highlight-color: transparent;
}

body {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #dbeafe 100%);
    color: var(--text-primary);
    direction: rtl;
    overflow-x: hidden;
    min-height: 100vh;
}

/* تصميم شريط الحالة المتميز */
.status-bar {
    background: transparent;
    color: var(--text-primary);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    font-weight: 500;
    backdrop-filter: blur(20px);
    position: relative;
    z-index: 1000;
}

.status-bar::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--glass);
    backdrop-filter: blur(20px);
    z-index: -1;
}

/* التطبيق الرئيسي */
.premium-app {
    max-width: 428px;
    margin: 0 auto;
    background: transparent;
    min-height: 100vh;
    position: relative;
    overflow: hidden;
}

/* الخلفية الديناميكية */
.background-effects {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    pointer-events: none;
}

.floating-shapes {
    position: absolute;
    width: 100%;
    height: 100%;
}

.shape {
    position: absolute;
    border-radius: 50%;
    background: var(--gradient-primary);
    opacity: 0.1;
    animation: float 6s ease-in-out infinite;
}

.shape:nth-child(1) {
    width: 200px;
    height: 200px;
    top: 10%;
    left: 10%;
    animation-delay: 0s;
}

.shape:nth-child(2) {
    width: 150px;
    height: 150px;
    top: 60%;
    right: 20%;
    animation-delay: 2s;
}

.shape:nth-child(3) {
    width: 100px;
    height: 100px;
    bottom: 20%;
    left: 20%;
    animation-delay: 4s;
}

@keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
}

/* الهيدر المتقدم */
.appointment-header {
    background: var(--gradient-hospital);
    color: white;
    padding: 40px 24px 30px;
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    box-shadow: var(--shadow-glass);
    position: relative;
    overflow: hidden;
}

.header-background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="rgba(255,255,255,0.05)" points="0,1000 1000,0 1000,1000"/></svg>');
    background-size: cover;
}

.header-content {
    position: relative;
    z-index: 2;
    text-align: center;
}

.header-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
    background: linear-gradient(45deg, #fff, #dbeafe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-subtitle {
    font-size: 16px;
    opacity: 0.9;
    margin-bottom: 25px;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border-radius: var(--radius-md);
    padding: 15px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-value {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    opacity: 0.9;
}

/* المحتوى الرئيسي */
.appointment-content {
    padding: 25px 20px;
    padding-bottom: 120px;
}

.section-title {
    font-size: 20px;
    font-weight: 800;
    margin: 30px 0 20px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 12px;
    padding-right: 8px;
}

.section-title::before {
    content: '';
    width: 4px;
    height: 24px;
    background: var(--gradient-hospital);
    border-radius: 2px;
}

/* خطوات الحجز */
.booking-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    position: relative;
    padding: 0 10px;
}

.booking-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    right: 10%;
    left: 10%;
    height: 3px;
    background: #e2e8f0;
    z-index: 1;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    z-index: 2;
    position: relative;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    color: var(--text-secondary);
    margin-bottom: 8px;
    transition: var(--transition-smooth);
    border: 3px solid white;
}

.step.active .step-number {
    background: var(--gradient-hospital);
    color: white;
    transform: scale(1.1);
}

.step.completed .step-number {
    background: var(--success);
    color: white;
}

.step-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--text-secondary);
    text-align: center;
}

.step.active .step-label {
    color: var(--primary);
}

/* محتوى الخطوات */
.step-content {
    display: none;
}

.step-content.active {
    display: block;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* أزرار التنقل بين الخطوات */
.step-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 30px;
    gap: 15px;
}

.btn {
    padding: 14px 24px;
    border: none;
    border-radius: var(--radius-md);
    font-weight: 800;
    cursor: pointer;
    transition: var(--transition-bounce);
    font-size: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
    justify-content: center;
}

.btn-primary {
    background: var(--gradient-hospital);
    color: white;
}

.btn-secondary {
    background: var(--light);
    color: var(--text-primary);
    border: 2px solid #e2e8f0;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-soft);
}

.btn:active {
    transform: translateY(0);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* البحث المتقدم */
.search-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.search-container {
    position: relative;
    margin-bottom: 20px;
}

.search-input {
    width: 100%;
    padding: 15px 50px 15px 15px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    font-size: 16px;
    transition: var(--transition-smooth);
}

.search-input:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
}

.search-filters {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.filter-select {
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    font-size: 14px;
    background: white;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.filter-select:focus {
    border-color: var(--primary);
    outline: none;
}

/* التخصصات */
.specialties-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.specialties-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 20px;
}

.specialty-card {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    padding: 20px 12px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.specialty-card:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
}

.specialty-card.active {
    background: var(--primary-light);
    border-color: var(--primary);
}

.specialty-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    background: var(--gradient-hospital);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 20px;
    color: white;
}

.specialty-name {
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 6px;
}

.specialty-count {
    font-size: 11px;
    color: var(--text-secondary);
}

/* الأطباء */
.doctors-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.doctors-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
    margin-top: 20px;
}

.doctor-card {
    background: #f8fafc;
    border-radius: var(--radius-lg);
    padding: 20px;
    display: flex;
    gap: 15px;
    cursor: pointer;
    transition: var(--transition-bounce);
    border: 2px solid transparent;
}

.doctor-card:hover {
    transform: translateX(-8px);
    border-color: var(--primary);
    box-shadow: var(--shadow-soft);
}

.doctor-card.selected {
    background: var(--primary-light);
    border-color: var(--primary);
}

.doctor-avatar {
    width: 70px;
    height: 70px;
    border-radius: var(--radius-md);
    background: var(--gradient-hospital);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
    flex-shrink: 0;
}

.doctor-info {
    flex: 1;
}

.doctor-name {
    font-weight: 800;
    font-size: 16px;
    margin-bottom: 6px;
}

.doctor-specialty {
    font-size: 14px;
    color: var(--text-secondary);
    margin-bottom: 8px;
}

.doctor-rating {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.stars {
    color: #f59e0b;
}

.rating-value {
    font-weight: 700;
    font-size: 14px;
}

.rating-count {
    font-size: 12px;
    color: var(--text-secondary);
}

.doctor-features {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.feature-tag {
    background: var(--primary-light);
    color: var(--primary);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
}

.doctor-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
    justify-content: center;
}

.select-btn {
    background: var(--gradient-hospital);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: var(--radius-md);
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.select-btn:hover {
    transform: translateY(-2px);
}

.price {
    font-weight: 800;
    font-size: 14px;
    color: var(--primary);
    text-align: center;
}

/* تفاصيل الطبيب المختار */
.appointment-details-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 2px solid var(--primary);
}

.selected-doctor-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

/* التقويم */
.calendar-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.current-month {
    font-size: 18px;
    font-weight: 800;
    color: var(--text-primary);
}

.nav-btn {
    background: var(--light);
    border: 2px solid #e2e8f0;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.nav-btn:hover {
    background: var(--primary-light);
    border-color: var(--primary);
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
    margin-bottom: 15px;
}

.calendar-day-header {
    text-align: center;
    font-weight: 700;
    font-size: 12px;
    color: var(--text-secondary);
    padding: 8px 0;
}

.calendar-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition-smooth);
    font-weight: 600;
    font-size: 14px;
}

.calendar-day:hover {
    background: var(--primary-light);
}

.calendar-day.selected {
    background: var(--gradient-hospital);
    color: white;
    transform: scale(1.1);
}

.calendar-day.disabled {
    color: var(--text-light);
    cursor: not-allowed;
    opacity: 0.5;
}

.calendar-day.today {
    background: var(--accent);
    color: white;
}

/* المواعيد المتاحة */
.time-slots-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 20px;
}

.time-slot {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    padding: 12px 8px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
    font-weight: 600;
    font-size: 14px;
}

.time-slot:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
}

.time-slot.selected {
    background: var(--gradient-hospital);
    color: white;
    border-color: var(--primary);
}

.time-slot.disabled {
    background: #f1f5f9;
    color: var(--text-light);
    cursor: not-allowed;
    opacity: 0.6;
}

/* ملخص الحجز */
.appointment-summary-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 2px solid var(--success);
}

.summary-header {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 20px;
    color: var(--text-primary);
    text-align: center;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    padding: 12px 0;
    border-bottom: 1px solid #e2e8f0;
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.summary-value {
    font-weight: 700;
    color: var(--text-primary);
}

/* النماذج */
.form-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 700;
    color: var(--text-primary);
    font-size: 14px;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    font-size: 16px;
    transition: var(--transition-smooth);
    background: white;
    font-family: 'Tajawal', sans-serif;
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-hint {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: var(--text-secondary);
}

/* Radio Buttons */
.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 600;
}

.radio-custom {
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-radius: 50%;
    position: relative;
    transition: var(--transition-smooth);
}

.radio-label input {
    display: none;
}

.radio-label input:checked + .radio-custom {
    border-color: var(--primary);
    background: var(--primary);
}

.radio-label input:checked + .radio-custom::after {
    content: '';
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Checkbox */
.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-bottom: 15px;
}

.checkbox-custom {
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-sm);
    position: relative;
    transition: var(--transition-smooth);
}

.checkbox-label input {
    display: none;
}

.checkbox-label input:checked + .checkbox-custom {
    border-color: var(--primary);
    background: var(--primary);
}

.checkbox-label input:checked + .checkbox-custom::after {
    content: '✓';
    color: white;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
}

/* رفع الملفات */
.file-upload-container {
    margin-top: 10px;
}

.file-upload-btn {
    background: var(--light);
    border: 2px dashed #e2e8f0;
    padding: 20px;
    border-radius: var(--radius-md);
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
    width: 100%;
    color: var(--text-secondary);
    font-weight: 600;
}

.file-upload-btn:hover {
    border-color: var(--primary);
    background: var(--primary-light);
}

.file-list {
    margin-top: 15px;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8fafc;
    border-radius: var(--radius-sm);
    margin-bottom: 8px;
}

.file-name {
    font-size: 14px;
    font-weight: 600;
}

.file-remove {
    color: var(--error);
    cursor: pointer;
    padding: 5px;
}

/* التأمين */
.insurance-section {
    background: #f8fafc;
    border-radius: var(--radius-md);
    padding: 20px;
    margin-top: 20px;
}

.insurance-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e2e8f0;
}

/* الدفع */
.payment-summary-card {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 2px solid var(--primary);
}

.appointment-number {
    background: var(--primary-light);
    color: var(--primary);
    padding: 12px;
    border-radius: var(--radius-md);
    font-family: monospace;
    font-weight: 700;
    text-align: center;
    margin: 15px 0;
    font-size: 18px;
}

.summary-item.total {
    background: #f8fafc;
    padding: 15px;
    border-radius: var(--radius-md);
    margin-top: 10px;
    border: 2px solid var(--success);
}

.summary-item.total .summary-value {
    font-size: 18px;
    color: var(--success);
}

/* طرق الدفع */
.payment-methods-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.payment-methods {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin: 20px 0;
}

.payment-method {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: var(--radius-md);
    padding: 20px 12px;
    text-align: center;
    cursor: pointer;
    transition: var(--transition-smooth);
}

.payment-method:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
}

.payment-method.active {
    background: var(--primary-light);
    border-color: var(--primary);
}

.method-icon {
    width: 50px;
    height: 50px;
    border-radius: var(--radius-md);
    background: var(--gradient-hospital);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 12px;
    font-size: 20px;
    color: white;
}

.method-name {
    font-weight: 700;
    font-size: 13px;
}

.payment-details {
    margin-top: 20px;
    padding: 20px;
    background: #f8fafc;
    border-radius: var(--radius-md);
}

.balance-info {
    background: var(--success);
    color: white;
    padding: 10px;
    border-radius: var(--radius-sm);
    text-align: center;
    font-weight: 700;
    margin-top: 10px;
}

.cash-notice {
    background: var(--warning);
    color: white;
    padding: 15px;
    border-radius: var(--radius-md);
    text-align: center;
    font-weight: 600;
}

/* الأمان */
.security-section {
    background: var(--surface);
    border-radius: var(--radius-lg);
    padding: 20px;
    box-shadow: var(--shadow-card);
    margin-bottom: 25px;
    border: 1px solid #f1f5f9;
}

.security-notice {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: center;
    color: var(--success);
    font-weight: 700;
}

/* النوافذ المنبثقة */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal-content {
    background: white;
    border-radius: var(--radius-xl);
    padding: 30px;
    max-width: 400px;
    width: 100%;
    box-shadow: var(--shadow-large);
    animation: modalAppear 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    max-height: 90vh;
    overflow-y: auto;
}

@keyframes modalAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(50px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f1f5f9;
}

.modal-title {
    font-size: 22px;
    font-weight: 800;
    color: var(--text-primary);
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-secondary);
    transition: var(--transition-smooth);
}

.close-modal:hover {
    color: var(--error);
    transform: rotate(90deg);
}

/* تأكيد الحجز */
.confirmation-content {
    text-align: center;
    padding: 20px 0;
}

.success-icon {
    font-size: 64px;
    color: var(--success);
    margin-bottom: 20px;
}

.confirmation-content h3 {
    margin-bottom: 10px;
    color: var(--text-primary);
}

.confirmation-content p {
    color: var(--text-secondary);
    margin-bottom: 20px;
    line-height: 1.6;
}

.appointment-details {
    background: #f8fafc;
    border-radius: var(--radius-lg);
    padding: 20px;
    margin: 20px 0;
    text-align: right;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #e2e8f0;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: var(--text-secondary);
}

.detail-value {
    font-weight: 700;
    color: var(--text-primary);
}

.reminder-notice {
    background: var(--primary-light);
    color: var(--primary);
    padding: 15px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    gap: 10px;
    justify-content: center;
    font-weight: 600;
    margin: 20px 0;
}

.modal-actions {
    display: flex;
    gap: 12px;
    margin-top: 25px;
}

.modal-actions .btn {
    flex: 1;
}

/* شريط التنقل السفلي */
.bottom-nav-premium {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--glass);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    padding: 15px;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-soft);
    z-index: 1000;
    max-width: 380px;
    width: calc(100% - 40px);
}

.nav-item-premium {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 12px;
    border-radius: var(--radius-md);
    transition: var(--transition-bounce);
    flex: 1;
    position: relative;
    text-decoration: none;
    color: inherit;
}

.nav-item-premium.active {
    background: var(--gradient-hospital);
    color: white;
    transform: translateY(-10px);
}

.nav-item-premium.active .nav-label {
    color: white;
}

.nav-item-premium.active::before {
    content: '';
    position: absolute;
    top: -8px;
    width: 20px;
    height: 3px;
    background: var(--gradient-hospital);
    border-radius: 2px;
}

.nav-icon-premium {
    font-size: 20px;
    margin-bottom: 6px;
    transition: var(--transition-smooth);
}

.nav-item-premium.active .nav-icon-premium {
    transform: scale(1.2);
}

.nav-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-secondary);
}

/* الإشعارات */
.notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--success);
    color: white;
    padding: 16px 24px;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-large);
    z-index: 3000;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: slideDown 0.3s ease-out;
}

.notification.error {
    background: var(--error);
}

.notification.warning {
    background: var(--warning);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

/* التكيف مع الشاشات */
@media (max-width: 428px) {
    .specialties-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .search-filters {
        grid-template-columns: 1fr;
    }
    
    .time-slots-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .payment-methods {
        grid-template-columns: 1fr;
    }
    
    .modal-actions {
        flex-direction: column;
    }
    
    .step-actions {
        flex-direction: column;
    }
    
    .radio-group {
        flex-direction: column;
        gap: 10px;
    }
    
    .doctor-card {
        flex-direction: column;
        text-align: center;
    }
    
    .doctor-actions {
        flex-direction: row;
        justify-content: center;
    }
}
</style>
</head>
<body>
    <!-- تأثيرات الخلفية الديناميكية -->
    <div class="background-effects">
        <div class="floating-shapes">
            <div class="shape"></div>
            <div class="shape"></div>
            <div class="shape"></div>
        </div>
    </div>

    <!-- شريط الحالة -->
    <div class="status-bar">
        <div class="status-left">
            <span id="currentTime">2:45</span>
        </div>
        <div class="status-right">
            <i class="fas fa-signal"></i>
            <i class="fas fa-wifi"></i>
            <i class="fas fa-battery-three-quarters"></i>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div class="premium-app">
        <!-- الهيدر -->
        <div class="appointment-header">
            <div class="header-background"></div>
            <div class="header-content">
                <h1 class="header-title">حجز موعد مع دكتور</h1>
                <p class="header-subtitle">احجز موعدك مع أفضل الأطباء المتخصصين</p>
                
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value">200+</div>
                        <div class="stat-label">طبيب متخصص</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">24/7</div>
                        <div class="stat-label">حجز إلكتروني</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">4.9</div>
                        <div class="stat-label">تقييم المرضى</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="appointment-content">
            <!-- خطوات الحجز -->
            <div class="booking-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">اختر الطبيب</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">حدد الموعد</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">اكتب التفاصيل</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">ادفع وأكد</div>
                </div>
            </div>

            <!-- الخطوة 1: اختيار الطبيب -->
            <div class="step-content active" id="step1">
                <div class="section-title">اختر طبيبك</div>
                
                <!-- البحث المتقدم -->
                <div class="search-section">
                    <div class="search-container">
                        <input type="text" class="search-input" id="doctorSearch" placeholder="ابحث عن طبيب أو تخصص...">
                        <i class="fas fa-search search-icon"></i>
                    </div>
                    <div class="search-filters">
                        <select class="filter-select" id="specialtyFilter">
                            <option value="">جميع التخصصات</option>
                            <option value="cardiology">أمراض القلب</option>
                            <option value="neurology">الأعصاب</option>
                            <option value="pediatrics">طب الأطفال</option>
                            <option value="surgery">الجراحة</option>
                            <option value="eyes">العيون</option>
                            <option value="teeth">الأسنان</option>
                            <option value="skin">الجلدية</option>
                            <option value="internal">الباطنية</option>
                        </select>
                        <select class="filter-select" id="locationFilter">
                            <option value="">جميع المناطق</option>
                            <option value="sanaa">صنعاء</option>
                            <option value="aden">عدن</option>
                            <option value="taiz">تعز</option>
                            <option value="hodeidah">الحديدة</option>
                            <option value="ibb">إب</option>
                        </select>
                    </div>
                </div>

                <!-- التخصصات -->
                <div class="section-title">التخصصات الطبية</div>
                <div class="specialties-section">
                    <div class="specialties-grid" id="specialtiesGrid">
                        <!-- سيتم تعبئتها بالجافاسكربت -->
                    </div>
                </div>

                <!-- الأطباء -->
                <div class="section-title">الأطباء المتاحون</div>
                <div class="doctors-section">
                    <div class="doctors-grid" id="doctorsGrid">
                        <!-- سيتم تعبئتها بالجافاسكربت -->
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-primary next-step" data-next="2" disabled>
                        التالي <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>

            <!-- الخطوة 2: تحديد الموعد -->
            <div class="step-content" id="step2">
                <div class="section-title">حدد تاريخ ووقت الموعد</div>
                
                <div class="appointment-details-card">
                    <div class="selected-doctor-info">
                        <div class="doctor-avatar" id="selectedDoctorAvatar">👨‍⚕️</div>
                        <div class="doctor-info">
                            <div class="doctor-name" id="selectedDoctorName">---</div>
                            <div class="doctor-specialty" id="selectedDoctorSpecialty">---</div>
                            <div class="doctor-price" id="selectedDoctorPrice">--- ر.ي</div>
                        </div>
                    </div>
                </div>

                <div class="calendar-section">
                    <div class="calendar-header">
                        <button class="nav-btn prev-month"><i class="fas fa-chevron-right"></i></button>
                        <div class="current-month" id="currentMonth">مارس 2024</div>
                        <button class="nav-btn next-month"><i class="fas fa-chevron-left"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- سيتم تعبئتها بالجافاسكربت -->
                    </div>
                </div>

                <div class="time-slots-section">
                    <div class="section-title">المواعيد المتاحة</div>
                    <div class="time-slots-grid" id="timeSlotsGrid">
                        <!-- سيتم تعبئتها بالجافاسكربت -->
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary prev-step" data-prev="1">
                        <i class="fas fa-arrow-right"></i> السابق
                    </button>
                    <button class="btn btn-primary next-step" data-next="3" disabled>
                        التالي <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>

            <!-- الخطوة 3: تفاصيل الحجز -->
            <div class="step-content" id="step3">
                <div class="section-title">تفاصيل الموعد</div>
                
                <div class="appointment-summary-card">
                    <div class="summary-header">ملخص الحجز</div>
                    <div class="summary-item">
                        <span class="summary-label">الطبيب:</span>
                        <span class="summary-value" id="summaryDoctor">---</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">التاريخ:</span>
                        <span class="summary-value" id="summaryDate">---</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">الوقت:</span>
                        <span class="summary-value" id="summaryTime">---</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">التكلفة:</span>
                        <span class="summary-value" id="summaryCost">--- ر.ي</span>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-group">
                        <label class="form-label">سبب الزيارة *</label>
                        <select class="form-select" id="visitReason" required>
                            <option value="">اختر سبب الزيارة</option>
                            <option value="checkup">فحص دوري</option>
                            <option value="followup">متابعة حالة</option>
                            <option value="consultation">استشارة طبية</option>
                            <option value="emergency">حالة طارئة</option>
                            <option value="prescription">تجديد روشتة</option>
                            <option value="other">سبب آخر</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">وصف الحالة *</label>
                        <textarea class="form-textarea" id="conditionDescription" 
                                  placeholder="صف حالتك الصحية والأعراض التي تعاني منها..." 
                                  rows="4" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">هل هذه أول زيارة؟ *</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="firstVisit" value="yes" required>
                                <span class="radio-custom"></span>
                                نعم، أول زيارة
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="firstVisit" value="no" required>
                                <span class="radio-custom"></span>
                                لا، زيارات سابقة
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">المرفقات (اختياري)</label>
                        <div class="file-upload-container">
                            <input type="file" id="medicalFiles" multiple accept="image/*,.pdf,.doc,.docx" style="display: none;">
                            <button type="button" class="file-upload-btn" onclick="document.getElementById('medicalFiles').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                رفع التقارير الطبية
                            </button>
                            <div class="file-list" id="fileList"></div>
                        </div>
                        <small class="form-hint">يمكنك رفع الصور، التقارير، أو التحاليل الطبية (الحد الأقصى 5 ملفات)</small>
                    </div>

                    <div class="insurance-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="hasInsurance">
                            <span class="checkbox-custom"></span>
                            لدي تأمين طبي
                        </label>
                        <div class="insurance-details" id="insuranceDetails" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">شركة التأمين</label>
                                <input type="text" class="form-input" id="insuranceCompany" placeholder="اسم شركة التأمين">
                            </div>
                            <div class="form-group">
                                <label class="form-label">رقم البوليصة</label>
                                <input type="text" class="form-input" id="policyNumber" placeholder="رقم البوليصة">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary prev-step" data-prev="2">
                        <i class="fas fa-arrow-right"></i> السابق
                    </button>
                    <button class="btn btn-primary next-step" data-next="4">
                        التالي <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            </div>

            <!-- الخطوة 4: الدفع والتأكيد -->
            <div class="step-content" id="step4">
                <div class="section-title">الدفع وتأكيد الحجز</div>
                
                <div class="payment-summary-card">
                    <div class="summary-header">تفاصيل الدفع</div>
                    <div class="appointment-number" id="appointmentNumber">APT-2024-001</div>
                    
                    <div class="summary-item">
                        <span class="summary-label">الطبيب:</span>
                        <span class="summary-value" id="paymentDoctor">---</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">الموعد:</span>
                        <span class="summary-value" id="paymentDateTime">---</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">سبب الزيارة:</span>
                        <span class="summary-value" id="paymentReason">---</span>
                    </div>
                    <div class="summary-item total">
                        <span class="summary-label">المبلغ المستحق:</span>
                        <span class="summary-value" id="paymentAmount">--- ر.ي</span>
                    </div>
                </div>

                <div class="payment-methods-section">
                    <div class="section-title">طريقة الدفع</div>
                    
                    <div class="payment-methods">
                        <div class="payment-method active" data-method="wallet">
                            <div class="method-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="method-name">المحفظة الرقمية</div>
                        </div>
                        <div class="payment-method" data-method="card">
                            <div class="method-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="method-name">البطاقة الائتمانية</div>
                        </div>
                        <div class="payment-method" data-method="cash">
                            <div class="method-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="method-name">الدفع في العيادة</div>
                        </div>
                    </div>

                    <div class="payment-details" id="walletPayment">
                        <div class="form-group">
                            <label class="form-label">اختر المحفظة</label>
                            <select class="form-select" id="selectedWallet" required>
                                <option value="">اختر المحفظة</option>
                            </select>
                        </div>
                        <div class="balance-info">
                            الرصيد المتاح: <span id="walletBalance">0 ر.ي</span>
                        </div>
                    </div>

                    <div class="payment-details" id="cardPayment" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">اختر البطاقة</label>
                            <select class="form-select" id="selectedCard" required>
                                <option value="">اختر البطاقة</option>
                            </select>
                        </div>
                    </div>

                    <div class="payment-details" id="cashPayment" style="display: none;">
                        <div class="cash-notice">
                            <i class="fas fa-info-circle"></i>
                            سيتم حجز الموعد وسوف تقوم بالدفع نقداً في العيادة عند وصولك.
                        </div>
                    </div>
                </div>

                <div class="security-section">
                    <div class="security-notice">
                        <i class="fas fa-shield-alt"></i>
                        <span>جميع معاملاتك محمية ومشفرة</span>
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary prev-step" data-prev="3">
                        <i class="fas fa-arrow-right"></i> السابق
                    </button>
                    <button class="btn btn-primary confirm-booking" id="confirmBooking">
                        <i class="fas fa-check-circle"></i>
                        تأكيد الحجز والدفع
                    </button>
                </div>
            </div>
        </div>

        <!-- نوافذ منبثقة -->
        
        <!-- نافذة تأكيد الحجز -->
        <div id="confirmationModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">تم الحجز بنجاح</div>
                    <button class="close-modal" onclick="closeModal('confirmationModal')">×</button>
                </div>
                
                <div class="confirmation-content">
                    <div class="success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>تم تأكيد حجز موعدك</h3>
                    <p>سنرسل لك رسالة تأكيد بالتفاصيل على بريدك الإلكتروني ورقم هاتفك</p>
                    
                    <div class="appointment-details">
                        <div class="detail-item">
                            <span class="detail-label">رقم الحجز:</span>
                            <span class="detail-value" id="finalAppointmentNumber">APT-2024-001</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الطبيب:</span>
                            <span class="detail-value" id="finalDoctorName">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">التاريخ والوقت:</span>
                            <span class="detail-value" id="finalAppointmentTime">---</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">العنوان:</span>
                            <span class="detail-value" id="finalClinicAddress">---</span>
                        </div>
                    </div>

                    <div class="reminder-notice">
                        <i class="fas fa-bell"></i>
                        <span>سيتم تذكيرك قبل الموعد بـ 24 ساعة و 2 ساعة</span>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="closeModal('confirmationModal'); window.location.href='index.html'">
                        <i class="fas fa-home"></i>
                        العودة للرئيسية
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('confirmationModal')">
                        <i class="fas fa-calendar-alt"></i>
                        عرض جميع المواعيد
                    </button>
                </div>
            </div>
        </div>

        <!-- شريط التنقل السفلي -->
        <div class="bottom-nav-premium">
            <a href="index.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-home"></i>
                </div>
                <div class="nav-label">الرئيسية</div>
            </a>
            <a href="consultation.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <div class="nav-label">الاستشارات</div>
            </a>
            <a href="doctor-appointment.html" class="nav-item-premium active">
                <div class="nav-icon-premium">
                    <i class="fas fa-calendar-plus"></i>
                </div>
                <div class="nav-label">حجز موعد</div>
            </a>
            <a href="financial.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="nav-label">المال</div>
            </a>
            <a href="profile.html" class="nav-item-premium">
                <div class="nav-icon-premium">
                    <i class="fas fa-user"></i>
                </div>
                <div class="nav-label">حسابي</div>
            </a>
        </div>
    </div>

    <script>
   // نظام حجز المواعيد المتكامل
class DoctorAppointmentSystem {
    constructor() {
        this.specialties = [];
        this.doctors = [];
        this.userAppointments = JSON.parse(localStorage.getItem('userAppointments')) || [];
        this.currentAppointment = {
            doctor: null,
            date: null,
            time: null,
            reason: '',
            description: '',
            isFirstVisit: null,
            attachments: [],
            insurance: null,
            paymentMethod: 'wallet'
        };
        this.currentStep = 1;
        this.currentMonth = new Date();
        this.init();
    }

    init() {
        this.loadSpecialties();
        this.loadDoctors();
        this.setupEventListeners();
        this.updateTime();
        this.loadUserData();
        this.initializeCalendar();
        setInterval(() => this.updateTime(), 60000);
    }

    setupEventListeners() {
        // البحث في الوقت الحقيقي
        const doctorSearch = document.getElementById('doctorSearch');
        if (doctorSearch) {
            doctorSearch.addEventListener('input', (e) => {
                this.handleSearch(e.target.value);
            });
        }

        // الفلاتر
        const specialtyFilter = document.getElementById('specialtyFilter');
        if (specialtyFilter) {
            specialtyFilter.addEventListener('change', () => {
                this.applyFilters();
            });
        }

        const locationFilter = document.getElementById('locationFilter');
        if (locationFilter) {
            locationFilter.addEventListener('change', () => {
                this.applyFilters();
            });
        }

        // التنقل بين الخطوات
        document.querySelectorAll('.next-step').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const nextStep = parseInt(e.target.closest('.next-step').dataset.next);
                this.goToStep(nextStep);
            });
        });

        document.querySelectorAll('.prev-step').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const prevStep = parseInt(e.target.closest('.prev-step').dataset.prev);
                this.goToStep(prevStep);
            });
        });

        // التأمين الطبي
        const hasInsurance = document.getElementById('hasInsurance');
        if (hasInsurance) {
            hasInsurance.addEventListener('change', (e) => {
                this.toggleInsuranceDetails(e.target.checked);
            });
        }

        // طرق الدفع
        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', (e) => {
                this.selectPaymentMethod(e.currentTarget.dataset.method);
            });
        });

        // تأكيد الحجز
        const confirmBooking = document.getElementById('confirmBooking');
        if (confirmBooking) {
            confirmBooking.addEventListener('click', () => {
                this.confirmBooking();
            });
        }

        // رفع الملفات
        const medicalFiles = document.getElementById('medicalFiles');
        if (medicalFiles) {
            medicalFiles.addEventListener('change', (e) => {
                this.handleFileUpload(e.target.files);
            });
        }

        // التنقل في التقويم
        const prevMonth = document.querySelector('.prev-month');
        const nextMonth = document.querySelector('.next-month');
        
        if (prevMonth) {
            prevMonth.addEventListener('click', () => {
                this.navigateMonth(-1);
            });
        }
        
        if (nextMonth) {
            nextMonth.addEventListener('click', () => {
                this.navigateMonth(1);
            });
        }
    }

    loadUserData() {
        this.userAccount = JSON.parse(localStorage.getItem('financialAccount'));
        this.userWallets = JSON.parse(localStorage.getItem('linkedWallets')) || [];
        this.userCards = JSON.parse(localStorage.getItem('linkedCards')) || [];
    }

    loadSpecialties() {
        this.specialties = [
            {
                id: 1,
                name: 'أمراض القلب',
                icon: 'fa-heartbeat',
                doctorCount: 25,
                color: '#ef4444',
                description: 'تشخيص وعلاج أمراض القلب والشرايين'
            },
            {
                id: 2,
                name: 'الأعصاب',
                icon: 'fa-brain',
                doctorCount: 18,
                color: '#8b5cf6',
                description: 'علاج اضطرابات الجهاز العصبي'
            },
            {
                id: 3,
                name: 'طب الأطفال',
                icon: 'fa-baby',
                doctorCount: 32,
                color: '#3b82f6',
                description: 'رعاية صحية شاملة للأطفال'
            },
            {
                id: 4,
                name: 'الجراحة',
                icon: 'fa-syringe',
                doctorCount: 15,
                color: '#f59e0b',
                description: 'عمليات جراحية وتشخيصية'
            },
            {
                id: 5,
                name: 'العيون',
                icon: 'fa-eye',
                doctorCount: 12,
                color: '#06b6d4',
                description: 'علاج أمراض العيون والرؤية'
            },
            {
                id: 6,
                name: 'الأسنان',
                icon: 'fa-tooth',
                doctorCount: 20,
                color: '#84cc16',
                description: 'عناية شاملة بصحة الفم والأسنان'
            },
            {
                id: 7,
                name: 'الجلدية',
                icon: 'fa-allergies',
                doctorCount: 14,
                color: '#f97316',
                description: 'علاج الأمراض الجلدية والتجميل'
            },
            {
                id: 8,
                name: 'الباطنية',
                icon: 'fa-stethoscope',
                doctorCount: 28,
                color: '#ec4899',
                description: 'تشخيص وعلاج الأمراض الداخلية'
            }
        ];
        this.renderSpecialties();
    }

    loadDoctors() {
        this.doctors = [
            {
                id: 1,
                name: 'د. أحمد محمد',
                specialty: 'أمراض القلب',
                specialtyId: 1,
                rating: 4.8,
                ratingCount: 124,
                experience: '15 سنة',
                price: 150,
                location: 'sanaa',
                availability: ['now', 'today'],
                features: ['كشف دوري', 'متابعة', 'استشارة'],
                image: '👨‍⚕️',
                bio: 'استشاري أمراض القلب والشرايين، حاصل على البورد الأمريكي',
                education: 'دكتوراه في أمراض القلب - جامعة هارفارد',
                languages: ['العربية', 'الإنجليزية'],
                clinic: {
                    name: 'عيادة القلب المتخصصة',
                    address: 'شارع الزبيري، صنعاء',
                    phone: '017234567'
                },
                availableSlots: this.generateTimeSlots(true)
            },
            {
                id: 2,
                name: 'د. سارة خالد',
                specialty: 'طب الأطفال',
                specialtyId: 3,
                rating: 4.9,
                ratingCount: 98,
                experience: '12 سنة',
                price: 120,
                location: 'sanaa',
                availability: ['today', 'week'],
                features: ['كشف أطفال', 'تطعيمات', 'استشارة'],
                image: '👩‍⚕️',
                bio: 'استشارية طب الأطفال وحديثي الولادة',
                education: 'ماجستير طب الأطفال - جامعة الملك سعود',
                languages: ['العربية', 'الفرنسية'],
                clinic: {
                    name: 'مركز رعاية الطفل',
                    address: 'حي التعاون، صنعاء',
                    phone: '017234568'
                },
                availableSlots: this.generateTimeSlots(false)
            },
            {
                id: 3,
                name: 'د. محمد علي',
                specialty: 'الأعصاب',
                specialtyId: 2,
                rating: 4.7,
                ratingCount: 87,
                experience: '18 سنة',
                price: 180,
                location: 'aden',
                availability: ['now'],
                features: ['كشف أعصاب', 'متابعة', 'استشارة'],
                image: '👨‍⚕️',
                bio: 'أستاذ مساعد في طب الأعصاب، متخصص في الصداع والألم',
                education: 'بورد الأعصاب - المعهد القومي للأعصاب',
                languages: ['العربية', 'الإنجليزية'],
                clinic: {
                    name: 'عيادة الأعصاب المتقدمة',
                    address: 'كريتر، عدن',
                    phone: '027234569'
                },
                availableSlots: this.generateTimeSlots(true)
            },
            {
                id: 4,
                name: 'د. فاطمة عبدالله',
                specialty: 'الأسنان',
                specialtyId: 6,
                rating: 4.6,
                ratingCount: 76,
                experience: '10 سنة',
                price: 100,
                location: 'taiz',
                availability: ['today', 'week'],
                features: ['كشف أسنان', 'تنظيف', 'حشو'],
                image: '👩‍⚕️',
                bio: 'اختصاصية تجميل وزراعة الأسنان',
                education: 'دبلوم زراعة الأسنان - جامعة القاهرة',
                languages: ['العربية'],
                clinic: {
                    name: 'عيادة الابتسامة المشرقة',
                    address: 'شارع 26 سبتمبر، تعز',
                    phone: '047234570'
                },
                availableSlots: this.generateTimeSlots(false)
            },
            {
                id: 5,
                name: 'د. خالد إبراهيم',
                specialty: 'الجلدية',
                specialtyId: 7,
                rating: 4.8,
                ratingCount: 112,
                experience: '14 سنة',
                price: 130,
                location: 'hodeidah',
                availability: ['now', 'today'],
                features: ['كشف جلدي', 'علاج تجميلي', 'استشارة'],
                image: '👨‍⚕️',
                bio: 'استشاري الأمراض الجلدية والتناسلية',
                education: 'زمالة الأمراض الجلدية - لندن',
                languages: ['العربية', 'الإنجليزية'],
                clinic: {
                    name: 'مركز الجلدية والتجميل',
                    address: 'الشارع الجديد، الحديدة',
                    phone: '037234571'
                },
                availableSlots: this.generateTimeSlots(true)
            },
            {
                id: 6,
                name: 'د. منى السيد',
                specialty: 'الباطنية',
                specialtyId: 8,
                rating: 4.9,
                ratingCount: 145,
                experience: '16 سنة',
                price: 140,
                location: 'ibb',
                availability: ['today', 'week'],
                features: ['كشف باطني', 'متابعة', 'استشارة'],
                image: '👩‍⚕️',
                bio: 'استشارية الباطنية وأمراض السكري والغدد',
                education: 'دكتوراه الباطنية - جامعة عين شمس',
                languages: ['العربية', 'الإنجليزية'],
                clinic: {
                    name: 'عيادة الباطنية العامة',
                    address: 'حي المصينعة، إب',
                    phone: '057234572'
                },
                availableSlots: this.generateTimeSlots(false)
            }
        ];
        this.renderDoctors();
    }

    generateTimeSlots(isAvailableNow) {
        const slots = [];
        const now = new Date();
        
        if (isAvailableNow) {
            // إضافة مواعيد اليوم
            for (let i = 1; i <= 6; i++) {
                const slotTime = new Date(now);
                slotTime.setHours(9 + i * 2); // من 11 صباحاً
                slotTime.setMinutes(0);
                
                if (slotTime > now) {
                    slots.push({
                        time: slotTime.toTimeString().slice(0, 5),
                        display: slotTime.toLocaleTimeString('ar-EG', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: true 
                        }),
                        available: true
                    });
                }
            }
        } else {
            // إضافة مواعيد الأسبوع
            const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة'];
            for (let i = 1; i <= 3; i++) {
                const slotDate = new Date(now);
                slotDate.setDate(now.getDate() + i);
                
                for (let j = 0; j < 4; j++) {
                    const slotTime = new Date(slotDate);
                    slotTime.setHours(10 + j * 2);
                    slotTime.setMinutes(0);
                    
                    slots.push({
                        time: slotTime.toISOString(),
                        display: `${days[slotDate.getDay()]} - ${slotTime.toLocaleTimeString('ar-EG', { 
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: true 
                        })}`,
                        available: true
                    });
                }
            }
        }

        return slots;
    }

    renderSpecialties() {
        const container = document.getElementById('specialtiesGrid');
        if (!container) return;

        container.innerHTML = '';

        this.specialties.forEach(specialty => {
            const specialtyElement = document.createElement('div');
            specialtyElement.className = 'specialty-card';
            specialtyElement.onclick = () => this.filterBySpecialty(specialty.id);
            specialtyElement.title = specialty.description;
            
            specialtyElement.innerHTML = `
                <div class="specialty-icon" style="background: ${specialty.color}">
                    <i class="fas ${specialty.icon}"></i>
                </div>
                <div class="specialty-name">${specialty.name}</div>
                <div class="specialty-count">${specialty.doctorCount} طبيب</div>
            `;
            
            container.appendChild(specialtyElement);
        });
    }

    renderDoctors(filteredDoctors = null) {
        const container = document.getElementById('doctorsGrid');
        if (!container) return;

        const doctorsToShow = filteredDoctors || this.doctors;

        if (doctorsToShow.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                    <i class="fas fa-user-md" style="font-size: 48px; margin-bottom: 16px;"></i>
                    <div>لا توجد نتائج</div>
                    <p style="font-size: 14px; margin-top: 8px;">جرب تغيير معايير البحث</p>
                </div>
            `;
            return;
        }

        container.innerHTML = '';

        doctorsToShow.forEach(doctor => {
            const doctorElement = document.createElement('div');
            doctorElement.className = `doctor-card ${this.currentAppointment.doctor?.id === doctor.id ? 'selected' : ''}`;
            doctorElement.onclick = () => this.selectDoctor(doctor);
            
            const stars = this.generateStars(doctor.rating);
            const locationText = this.getLocationText(doctor.location);
            
            doctorElement.innerHTML = `
                <div class="doctor-avatar">
                    ${doctor.image}
                </div>
                <div class="doctor-info">
                    <div class="doctor-name">${doctor.name}</div>
                    <div class="doctor-specialty">${doctor.specialty} • ${doctor.experience}</div>
                    <div class="doctor-rating">
                        <div class="stars">${stars}</div>
                        <div class="rating-value">${doctor.rating}</div>
                        <div class="rating-count">(${doctor.ratingCount})</div>
                    </div>
                    <div class="doctor-features">
                        ${doctor.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        <i class="fas fa-map-marker-alt"></i>
                        ${locationText} • ${doctor.clinic.name}
                    </div>
                </div>
                <div class="doctor-actions">
                    <button class="select-btn" onclick="event.stopPropagation(); appointmentSystem.selectDoctor(${doctor.id})">
                        <i class="fas fa-calendar-check"></i>
                        اختر
                    </button>
                    <div class="price">${doctor.price} ر.ي</div>
                </div>
            `;
            
            container.appendChild(doctorElement);
        });
    }

    getLocationText(location) {
        const locations = {
            'sanaa': 'صنعاء',
            'aden': 'عدن',
            'taiz': 'تعز',
            'hodeidah': 'الحديدة',
            'ibb': 'إب'
        };
        return locations[location] || location;
    }

    generateStars(rating) {
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        
        let stars = '';
        
        for (let i = 0; i < fullStars; i++) {
            stars += '<i class="fas fa-star"></i>';
        }
        
        if (halfStar) {
            stars += '<i class="fas fa-star-half-alt"></i>';
        }
        
        for (let i = 0; i < emptyStars; i++) {
            stars += '<i class="far fa-star"></i>';
        }
        
        return stars;
    }

    selectDoctor(doctor) {
        if (typeof doctor === 'number') {
            doctor = this.doctors.find(d => d.id === doctor);
        }

        if (!doctor) {
            this.showNotification('الطبيب غير موجود', 'error');
            return;
        }

        this.currentAppointment.doctor = doctor;
        
        // تحديث الواجهة
        document.querySelectorAll('.doctor-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        event.target.closest('.doctor-card').classList.add('selected');
        
        // تفعيل زر التالي
        document.querySelector('.next-step[data-next="2"]').disabled = false;
        
        this.showNotification(`تم اختيار ${doctor.name}`, 'success');
    }

    handleSearch(query) {
        if (query.length >= 2) {
            const filteredDoctors = this.doctors.filter(doctor => 
                doctor.name.includes(query) || 
                doctor.specialty.includes(query) ||
                doctor.bio.includes(query) ||
                doctor.clinic.name.includes(query)
            );
            this.renderDoctors(filteredDoctors);
        } else if (query.length === 0) {
            this.renderDoctors();
        }
    }

    applyFilters() {
        const specialty = document.getElementById('specialtyFilter').value;
        const location = document.getElementById('locationFilter').value;
        
        let filteredDoctors = this.doctors;
        
        if (specialty) {
            filteredDoctors = filteredDoctors.filter(doctor => 
                doctor.specialty === specialty
            );
        }
        
        if (location) {
            filteredDoctors = filteredDoctors.filter(doctor => 
                doctor.location === location
            );
        }
        
        this.renderDoctors(filteredDoctors);
    }

    filterBySpecialty(specialtyId) {
        const filteredDoctors = this.doctors.filter(doctor => doctor.specialtyId === specialtyId);
        this.renderDoctors(filteredDoctors);
        
        // تحديث حالة التخصص النشط
        document.querySelectorAll('.specialty-card').forEach(card => {
            card.classList.remove('active');
        });
        event.target.closest('.specialty-card').classList.add('active');
        
        this.showNotification(`تم عرض أطباء التخصص المحدد`, 'info');
    }

    goToStep(step) {
        // التحقق من صحة البيانات قبل الانتقال
        if (step > this.currentStep) {
            if (!this.validateStep(this.currentStep)) {
                this.showNotification('يرجى إكمال البيانات المطلوبة', 'error');
                return;
            }
        }

        // تحديث الخطوات
        document.querySelectorAll('.step').forEach(stepElement => {
            stepElement.classList.remove('active');
            if (parseInt(stepElement.dataset.step) <= step) {
                stepElement.classList.add('completed');
            }
        });
        
        document.querySelector(`.step[data-step="${step}"]`).classList.add('active');

        // إخفاء جميع المحتويات
        document.querySelectorAll('.step-content').forEach(content => {
            content.classList.remove('active');
        });

        // إظهار المحتوى المطلوب
        document.getElementById(`step${step}`).classList.add('active');

        // تحديث البيانات إذا لزم الأمر
        if (step === 2) {
            this.updateSelectedDoctorInfo();
            this.generateTimeSlotsForDoctor();
        } else if (step === 3) {
            this.updateAppointmentSummary();
        } else if (step === 4) {
            this.updatePaymentSummary();
            this.loadPaymentMethods();
        }

        this.currentStep = step;
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    validateStep(step) {
        switch (step) {
            case 1:
                return !!this.currentAppointment.doctor;
            case 2:
                return !!this.currentAppointment.date && !!this.currentAppointment.time;
            case 3:
                const reason = document.getElementById('visitReason').value;
                const description = document.getElementById('conditionDescription').value;
                const firstVisit = document.querySelector('input[name="firstVisit"]:checked');
                return !!reason && !!description && !!firstVisit;
            default:
                return true;
        }
    }

    updateSelectedDoctorInfo() {
        if (!this.currentAppointment.doctor) return;

        const doctor = this.currentAppointment.doctor;
        
        document.getElementById('selectedDoctorAvatar').textContent = doctor.image;
        document.getElementById('selectedDoctorName').textContent = doctor.name;
        document.getElementById('selectedDoctorSpecialty').textContent = doctor.specialty;
        document.getElementById('selectedDoctorPrice').textContent = doctor.price + ' ر.ي';
    }

    initializeCalendar() {
        this.renderCalendar();
    }

    renderCalendar() {
        const calendarGrid = document.getElementById('calendarGrid');
        if (!calendarGrid) return;

        const monthNames = [
            'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
            'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
        ];

        const year = this.currentMonth.getFullYear();
        const month = this.currentMonth.getMonth();
        
        document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;

        // رؤوس الأيام
        const dayHeaders = ['أح', 'إث', 'ث', 'أر', 'خ', 'ج', 'س'];
        let calendarHTML = '';

        // إضافة رؤوس الأيام
        dayHeaders.forEach(day => {
            calendarHTML += `<div class="calendar-day-header">${day}</div>`;
        });

        // الحصول على أول يوم في الشهر
        const firstDay = new Date(year, month, 1);
        const startingDay = firstDay.getDay(); // 0 = الأحد, 1 = الإثنين, etc.

        // الحصول على عدد الأيام في الشهر
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // الأيام الفارغة قبل بداية الشهر
        for (let i = 0; i < startingDay; i++) {
            calendarHTML += `<div class="calendar-day disabled"></div>`;
        }

        // أيام الشهر
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(year, month, day);
            const isToday = currentDate.getTime() === today.getTime();
            const isSelected = this.currentAppointment.date && 
                              currentDate.toDateString() === new Date(this.currentAppointment.date).toDateString();
            const isPast = currentDate < today;
            const isAvailable = !isPast && currentDate.getDay() !== 5; // لا تظهر الجمعة

            let dayClass = 'calendar-day';
            if (isToday) dayClass += ' today';
            if (isSelected) dayClass += ' selected';
            if (!isAvailable) dayClass += ' disabled';

            calendarHTML += `
                <div class="${dayClass}" data-date="${currentDate.toISOString()}" 
                     onclick="${isAvailable ? 'appointmentSystem.selectDate(this.dataset.date)' : ''}">
                    ${day}
                </div>
            `;
        }

        calendarGrid.innerHTML = calendarHTML;
    }

    navigateMonth(direction) {
        this.currentMonth.setMonth(this.currentMonth.getMonth() + direction);
        this.renderCalendar();
    }

    selectDate(dateString) {
        this.currentAppointment.date = dateString;
        
        // تحديث الواجهة
        document.querySelectorAll('.calendar-day').forEach(day => {
            day.classList.remove('selected');
        });
        
        event.target.classList.add('selected');
        
        // توليد المواعيد المتاحة
        this.generateTimeSlotsForDoctor();
        
        this.showNotification('تم اختيار التاريخ', 'success');
    }

    generateTimeSlotsForDoctor() {
        if (!this.currentAppointment.doctor || !this.currentAppointment.date) return;

        const timeSlotsGrid = document.getElementById('timeSlotsGrid');
        if (!timeSlotsGrid) return;

        const doctor = this.currentAppointment.doctor;
        let timeSlotsHTML = '';

        // محاكاة مواعيد الطبيب
        const availableSlots = [
            '09:00', '10:00', '11:00', '12:00', '14:00', '15:00', '16:00', '17:00'
        ];

        availableSlots.forEach(slot => {
            const isSelected = this.currentAppointment.time === slot;
            const slotClass = `time-slot ${isSelected ? 'selected' : ''}`;
            
            const displayTime = new Date(`2000-01-01T${slot}`).toLocaleTimeString('ar-EG', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            timeSlotsHTML += `
                <div class="${slotClass}" data-time="${slot}" 
                     onclick="appointmentSystem.selectTime('${slot}')">
                    ${displayTime}
                </div>
            `;
        });

        timeSlotsGrid.innerHTML = timeSlotsHTML;
        
        // تفعيل زر التالي
        document.querySelector('.next-step[data-next="3"]').disabled = false;
    }

    selectTime(time) {
        this.currentAppointment.time = time;
        
        // تحديث الواجهة
        document.querySelectorAll('.time-slot').forEach(slot => {
            slot.classList.remove('selected');
        });
        
        event.target.classList.add('selected');
        
        this.showNotification('تم اختيار الوقت', 'success');
    }

    updateAppointmentSummary() {
        if (!this.currentAppointment.doctor || !this.currentAppointment.date || !this.currentAppointment.time) return;

        const doctor = this.currentAppointment.doctor;
        const date = new Date(this.currentAppointment.date);
        const time = this.currentAppointment.time;

        const formattedDate = date.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        const formattedTime = new Date(`2000-01-01T${time}`).toLocaleTimeString('ar-EG', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        document.getElementById('summaryDoctor').textContent = doctor.name;
        document.getElementById('summaryDate').textContent = formattedDate;
        document.getElementById('summaryTime').textContent = formattedTime;
        document.getElementById('summaryCost').textContent = doctor.price + ' ر.ي';
    }

    updatePaymentSummary() {
        if (!this.currentAppointment.doctor || !this.currentAppointment.date || !this.currentAppointment.time) return;

        const doctor = this.currentAppointment.doctor;
        const date = new Date(this.currentAppointment.date);
        const time = this.currentAppointment.time;
        const reason = document.getElementById('visitReason');
        const selectedReason = reason.options[reason.selectedIndex].text;

        const formattedDateTime = date.toLocaleDateString('ar-EG', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });

        document.getElementById('paymentDoctor').textContent = doctor.name;
        document.getElementById('paymentDateTime').textContent = formattedDateTime;
        document.getElementById('paymentReason').textContent = selectedReason;
        document.getElementById('paymentAmount').textContent = doctor.price + ' ر.ي';

        // تحديث رقم الحجز
        const appointmentNumber = 'APT-' + new Date().getFullYear() + '-' + String(this.userAppointments.length + 1).padStart(3, '0');
        document.getElementById('appointmentNumber').textContent = appointmentNumber;
    }

    toggleInsuranceDetails(show) {
        const insuranceDetails = document.getElementById('insuranceDetails');
        insuranceDetails.style.display = show ? 'block' : 'none';
        
        if (show) {
            this.currentAppointment.insurance = {
                hasInsurance: true,
                company: '',
                policyNumber: ''
            };
        } else {
            this.currentAppointment.insurance = null;
        }
    }

    selectPaymentMethod(method) {
        this.currentAppointment.paymentMethod = method;
        
        // تحديث الواجهة
        document.querySelectorAll('.payment-method').forEach(m => {
            m.classList.remove('active');
        });
        
        event.target.closest('.payment-method').classList.add('active');
        
        // إظهار تفاصيل طريقة الدفع المختارة
        document.querySelectorAll('.payment-details').forEach(details => {
            details.style.display = 'none';
        });
        
        document.getElementById(`${method}Payment`).style.display = 'block';
    }

    loadPaymentMethods() {
        this.loadUserData();
        
        const walletSelect = document.getElementById('selectedWallet');
        const cardSelect = document.getElementById('selectedCard');
        
        walletSelect.innerHTML = '<option value="">اختر المحفظة</option>';
        cardSelect.innerHTML = '<option value="">اختر البطاقة</option>';
        
        this.userWallets.forEach(wallet => {
            walletSelect.innerHTML += `<option value="${wallet.id}">${wallet.name} - ${wallet.balance} ر.ي</option>`;
        });
        
        this.userCards.forEach(card => {
            cardSelect.innerHTML += `<option value="${card.id}">${card.processor} - ${card.lastFour}</option>`;
        });

        // تحديث رصيد المحفظة
        const walletBalance = document.getElementById('walletBalance');
        if (walletBalance && this.userAccount) {
            walletBalance.textContent = this.userAccount.balance + ' ر.ي';
        }

        // إذا لم تكن هناك محافظ أو بطاقات، عرض رسالة
        if (this.userWallets.length === 0 && this.userCards.length === 0) {
            document.getElementById('selectedWallet').innerHTML = '<option value="">لا توجد محافظ مرتبطة</option>';
        }
    }

    handleFileUpload(files) {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        Array.from(files).slice(0, 5).forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <span class="file-name">${file.name}</span>
                <span class="file-remove" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </span>
            `;
            fileList.appendChild(fileItem);
            
            this.currentAppointment.attachments.push(file);
        });

        if (files.length > 5) {
            this.showNotification('تم رفع أول 5 ملفات فقط', 'warning');
        }
    }

    async confirmBooking() {
        // التحقق من البيانات
        if (!this.validateStep(4)) {
            this.showNotification('يرجى إكمال جميع البيانات المطلوبة', 'error');
            return;
        }

        // التحقق من طريقة الدفع
        if (this.currentAppointment.paymentMethod === 'wallet') {
            const selectedWallet = document.getElementById('selectedWallet').value;
            if (!selectedWallet) {
                this.showNotification('يرجى اختيار المحفظة', 'error');
                return;
            }

            // التحقق من الرصيد
            if (this.userAccount.balance < this.currentAppointment.doctor.price) {
                this.showNotification('رصيدك غير كافي، يرجى شحن الحساب', 'error');
                setTimeout(() => {
                    window.location.href = 'financial.html';
                }, 2000);
                return;
            }
        } else if (this.currentAppointment.paymentMethod === 'card') {
            const selectedCard = document.getElementById('selectedCard').value;
            if (!selectedCard) {
                this.showNotification('يرجى اختيار البطاقة', 'error');
                return;
            }
        }

        this.showNotification('جاري تأكيد الحجز...', 'info');

        try {
            const paymentResult = await this.processPayment();
            
            if (paymentResult.success) {
                this.finalizeAppointment(paymentResult);
            } else {
                this.showNotification(paymentResult.message, 'error');
            }
        } catch (error) {
            this.showNotification('حدث خطأ أثناء المعالجة', 'error');
        }
    }

    async processPayment() {
        return new Promise((resolve) => {
            setTimeout(() => {
                const success = Math.random() > 0.1; // 90% success rate
                
                if (success) {
                    resolve({
                        success: true,
                        transactionId: 'TXN' + Date.now(),
                        amount: this.currentAppointment.doctor.price,
                        method: this.currentAppointment.paymentMethod
                    });
                } else {
                    resolve({
                        success: false,
                        message: 'فشل عملية الدفع. يرجى المحاولة مرة أخرى'
                    });
                }
            }, 2000);
        });
    }

    finalizeAppointment(paymentResult) {
        const appointment = {
            id: Date.now(),
            number: document.getElementById('appointmentNumber').textContent,
            doctor: this.currentAppointment.doctor,
            date: this.currentAppointment.date,
            time: this.currentAppointment.time,
            reason: document.getElementById('visitReason').value,
            description: document.getElementById('conditionDescription').value,
            isFirstVisit: document.querySelector('input[name="firstVisit"]:checked').value,
            attachments: this.currentAppointment.attachments,
            insurance: this.currentAppointment.insurance,
            status: 'confirmed',
            createdAt: new Date().toISOString(),
            price: this.currentAppointment.doctor.price,
            payment: paymentResult,
            reminderSent: false
        };
        
        // تحديث رصيد المستخدم إذا كان الدفع من المحفظة
        if (this.currentAppointment.paymentMethod === 'wallet' && this.userAccount) {
            this.userAccount.balance -= appointment.price;
            localStorage.setItem('financialAccount', JSON.stringify(this.userAccount));
        }
        
        // إضافة إلى سجل المواعيد
        this.userAppointments.unshift(appointment);
        localStorage.setItem('userAppointments', JSON.stringify(this.userAppointments));
        
        // إضافة إلى سجل المعاملات إذا كان الدفع إلكتروني
        if (this.currentAppointment.paymentMethod !== 'cash') {
            this.addToTransactionHistory(appointment, paymentResult);
        }
        
        this.showNotification(`تم الحجز بنجاح: ${appointment.price} ر.ي`, 'success');
        
        // عرض تأكيد الحجز
        this.showConfirmationModal(appointment);
    }

    addToTransactionHistory(appointment, paymentResult) {
        const transactions = JSON.parse(localStorage.getItem('financialTransactions')) || [];
        
        const transaction = {
            id: paymentResult.transactionId,
            type: 'appointment',
            title: `موعد مع ${appointment.doctor.name}`,
            description: `كشف ${appointment.doctor.specialty} - ${appointment.reason}`,
            amount: -appointment.price,
            ref: appointment.number,
            date: new Date().toLocaleDateString('ar-EG'),
            time: new Date().toLocaleTimeString('ar-EG'),
            status: 'completed',
            icon: 'icon-appointment',
            method: paymentResult.method,
            doctor: appointment.doctor.name
        };
        
        transactions.unshift(transaction);
        localStorage.setItem('financialTransactions', JSON.stringify(transactions));
    }

    showConfirmationModal(appointment) {
        document.getElementById('finalAppointmentNumber').textContent = appointment.number;
        document.getElementById('finalDoctorName').textContent = appointment.doctor.name;
        
        const dateTime = new Date(appointment.date + 'T' + appointment.time);
        const formattedDateTime = dateTime.toLocaleDateString('ar-EG', { 
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
        
        document.getElementById('finalAppointmentTime').textContent = formattedDateTime;
        document.getElementById('finalClinicAddress').textContent = appointment.doctor.clinic.address;
        
        openModal('confirmationModal');
    }

    showNotification(message, type = 'info') {
        // إزالة أي إشعارات سابقة
        const existingNotifications = document.querySelectorAll('.notification');
        existingNotifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
            ${message}
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 4000);
    }

    updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ar-EG', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        const timeElement = document.getElementById('currentTime');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }
}

// وظائف الواجهة العامة
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// إغلاق النوافذ بالضغط خارجها
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

// منع إرسال النماذج
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
        });
    });
});

// تهيئة النظام عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    window.appointmentSystem = new DoctorAppointmentSystem();
    
    // إضافة تأثيرات تحميل أولية
    setTimeout(() => {
        if (window.appointmentSystem) {
            window.appointmentSystem.showNotification('مرحباً بك في نظام حجز المواعيد!', 'success');
        }
    }, 1000);
});

// جعل النظام متاحاً globally
window.DoctorAppointmentSystem = DoctorAppointmentSystem;
</script>
</body>
</html>